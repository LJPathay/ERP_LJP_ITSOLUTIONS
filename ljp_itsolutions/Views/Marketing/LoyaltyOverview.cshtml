@model IEnumerable<ljp_itsolutions.Models.Customer>
@{
    Layout = "_Layout";
    ViewData["Title"] = "Loyalty & Retained Tiers";
}

<div class="container-fluid py-2">
    <!-- Analytics Row -->
    <div class="row g-4 mb-4">
        <div class="col-xl-5">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h6 class="fw-bold mb-0">Tier Distribution Matrix</h6>
                    <p class="text-muted x-small mb-0">Market share by loyalty participation</p>
                </div>
                <div class="card-body p-4">
                    <div style="height: 280px;">
                        <canvas id="tierChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-7">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h6 class="fw-bold mb-0">Engagement Points Benchmark</h6>
                    <p class="text-muted x-small mb-0">Aggregate contributions across strategic demographics</p>
                </div>
                <div class="card-body p-4">
                    <div style="height: 280px;">
                        <canvas id="pointsDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Table -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">Strategic Loyalty Leaderboard</h6>
            <span class="badge rounded-pill bg-light text-dark border px-3">Top 10 Contributors</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="bg-light bg-opacity-50">
                        <tr>
                            <th class="ps-4 py-3 text-uppercase x-small fw-bold text-muted" style="width: 80px;">Index</th>
                            <th class="py-3 text-uppercase x-small fw-bold text-muted">Customer Identity</th>
                            <th class="py-3 text-uppercase x-small fw-bold text-muted text-center">Equity Value</th>
                            <th class="py-3 text-uppercase x-small fw-bold text-muted text-center">Account Tier</th>
                            <th class="pe-4 py-3 text-end text-uppercase x-small fw-bold text-muted">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ int rank = 1; }
                        @foreach (var customer in Model)
                        {
                             var tier = customer.Points >= 500 ? "Gold" : (customer.Points >= 300 ? "Silver" : (customer.Points >= 100 ? "Bronze" : "Member"));
                             var rankClass = rank == 1 ? "bg-warning text-dark" : (rank == 2 ? "bg-secondary" : (rank == 3 ? "bg-bronze text-white" : "bg-light text-dark"));
                             var tierClass = tier == "Gold" ? "bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10" : 
                                            (tier == "Silver" ? "bg-info bg-opacity-10 text-info border border-info border-opacity-10" : 
                                            (tier == "Bronze" ? "bg-secondary bg-opacity-10 text-secondary border" : "bg-light text-muted border"));

                            <tr>
                                <td class="ps-4">
                                    <div class="avatar-sm rounded-circle @rankClass d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                        @rank
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="avatar-xs rounded-circle bg-white shadow-sm border d-flex align-items-center justify-content-center fw-bold text-primary" style="width: 34px; height: 34px;">
                                            @customer.FullName.Substring(0, 1)
                                        </div>
                                        <div>
                                            <p class="mb-0 fw-bold text-dark small">@customer.FullName</p>
                                            <p class="text-muted x-small mb-0">Member #@customer.CustomerID.ToString().PadLeft(5, '0')</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold text-dark">@customer.Points.ToString("N0")</span>
                                    <span class="text-muted x-small ms-1">pts</span>
                                </td>
                                <td class="text-center">
                                     <span class="badge rounded-pill @tierClass px-3">
                                         @(tier == "Gold" ? "GOLD ELITE" : (tier == "Silver" ? "SILVER PRO" : (tier == "Bronze" ? "BRONZE" : "MEMBER")))
                                     </span>
                                </td>
                                <td class="pe-4 text-end">
                                    <span class="badge bg-success bg-opacity-10 text-success x-small border border-success border-opacity-10">ACTIVE POS</span>
                                </td>
                            </tr>
                            rank++;
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#4f46e5';
        const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim() || '#fbbf24';

        // Tier Distribution Chart
        const tierCtx = document.getElementById('tierChart').getContext('2d');
        new Chart(tierCtx, {
            type: 'doughnut',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.TierLabels)),
                datasets: [{
                    data: @Html.Raw(Json.Serialize(ViewBag.TierData)),
                    backgroundColor: [secondaryColor, '#6366f1', '#94a3b8', '#e2e8f0'],
                    borderWidth: 6,
                    borderColor: '#fff',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            usePointStyle: true, 
                            pointStyle: 'circle',
                            padding: 25,
                            font: { size: 11, weight: 'bold' },
                            color: '#64748b'
                        } 
                    }
                },
                cutout: '75%'
            }
        });

        // Top Points Distribution
        const pointsCtx = document.getElementById('pointsDistributionChart').getContext('2d');
        new Chart(pointsCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.Select(c => c.FullName.Split(' ')[0]))),
                datasets: [{
                    label: 'Loyalty Points (Equity)',
                    data: @Html.Raw(Json.Serialize(Model.Select(c => c.Points))),
                    backgroundColor: [primaryColor, secondaryColor, '#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#475569', '#94a3b8'],
                    borderRadius: 8,
                    barThickness: 28,
                    hoverBackgroundColor: '#0f172a'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#fff',
                        titleColor: '#1e293b',
                        bodyColor: '#1e293b',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#f1f5f9', drawBorder: false },
                        ticks: { color: '#64748b', font: { size: 10 } }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#64748b', font: { size: 10 } }
                    }
                }
            }
        });
    </script>
}

<style>
    .x-small { font-size: 0.75rem; }
    .bg-bronze { background-color: #cd7f32; }
</style>
