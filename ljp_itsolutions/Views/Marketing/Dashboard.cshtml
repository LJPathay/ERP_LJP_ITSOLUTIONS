@model dynamic
@{
    ViewData["Title"] = "Marketing Strategic Overview";
}

<div class="marketing-dashboard py-2">
    <!-- Quick Stats (Compact Premium Style) -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid #4f46e5 !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Total Reach</p>
                            <h4 class="fw-bold mb-0">@Model.TotalCustomers</h4>
                            <span class="text-success xx-small fw-bold"><i class="fas fa-arrow-up me-1"></i>+12% Trend</span>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-3 p-2 text-primary">
                            <i class="fas fa-user-friends"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid #10b981 !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Active Offers</p>
                            <h4 class="fw-bold mb-0">@Model.ActivePromotions</h4>
                            <span class="text-success xx-small fw-bold"><i class="fas fa-check-circle me-1"></i>Operational</span>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-3 p-2 text-success">
                            <i class="fas fa-tags"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid #f59e0b !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Loyalty Points</p>
                            <h4 class="fw-bold mb-0">@Model.TotalPointsAwarded</h4>
                            <span class="text-warning xx-small fw-bold">Network Equity</span>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-3 p-2 text-warning">
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid #0ea5e9 !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Conversions</p>
                            <h4 class="fw-bold mb-0">@Model.TotalOrders</h4>
                            <span class="text-info xx-small fw-bold"><i class="fas fa-caret-up me-1"></i>4.2% Growth</span>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-3 p-2 text-info">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Performance Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-bold mb-0">Engagement Velocity</h6>
                        <p class="text-muted x-small mb-0">Weekly campaign transaction volume</p>
                    </div>
                    <div class="badge rounded-pill bg-light text-dark border px-3">Real-time Data</div>
                </div>
                <div class="card-body p-4">
                    <canvas id="performanceChart" style="min-height: 300px; width: 100%;"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Customer Retention -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h6 class="fw-bold mb-0">Audience Composition</h6>
                </div>
                <div class="card-body p-4 d-flex flex-column align-items-center justify-content-center">
                    <div style="height: 220px; width: 100%;">
                        <canvas id="retentionChart"></canvas>
                    </div>
                    <div class="mt-4 w-100 p-3 bg-light rounded-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="x-small fw-bold text-muted text-uppercase tracking-wider">Returning Loyalty</span>
                            <span class="fw-bold text-primary">@Model.ReturningCustomersCount</span>
                        </div>
                        <div class="progress rounded-pill shadow-none" style="height: 8px;">
                            <div class="progress-bar bg-primary rounded-pill shadow-none" role="progressbar" 
                                 style="width: @(Model.TotalCustomers > 0 ? (Model.ReturningCustomersCount * 100 / Model.TotalCustomers) : 0)%; 
                                        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)) !important;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Top Customers -->
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0">VIP Performance Index</h6>
                    <a asp-action="Customers" class="btn btn-sm btn-light rounded-pill px-3 border-0 shadow-none">
                        All Personas <i class="fas fa-chevron-right ms-1 x-small opacity-50"></i>
                    </a>
                </div>
                <div class="card-body px-0 pt-2">
                    <div class="row px-4 g-3">
                        @foreach (var customer in Model.TopCustomers)
                        {
                            <div class="col-xl-3 col-md-6 mb-2">
                                <div class="p-3 border-0 bg-light rounded-4 d-flex align-items-center gap-3 transition-hover shadow-sm-hover border border-white">
                                    <div class="avatar-sm bg-white text-primary rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 44px; height: 44px; font-size: 1.1rem; border: 2px solid #fff;">
                                        @customer.FullName.Substring(0, 1)
                                    </div>
                                    <div class="flex-fill">
                                        <p class="mb-0 fw-bold x-small text-dark">@customer.FullName</p>
                                        <p class="text-success x-small fw-bold mb-0">@customer.Points pts</p>
                                    </div>
                                    <button class="btn btn-sm btn-white rounded-circle shadow-sm d-flex align-items-center justify-content-center ms-auto" 
                                            onclick="generateReward(@customer.CustomerID)" style="width: 32px; height: 32px;">
                                        <i class="fas fa-gift text-primary x-small"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="card-footer bg-light bg-opacity-50 border-0 text-center py-3">
                    <span class="x-small text-muted italic">Click the gift icon to provision immediate loyalty benefits to top-tier patrons.</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#4f46e5';
        const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim() || '#fbbf24';

        // Performance Chart Initialization
        const ctxPerformance = document.getElementById('performanceChart').getContext('2d');
        new Chart(ctxPerformance, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.ChartLabels)),
                datasets: [{
                    label: 'Engagement Volume',
                    data: @Html.Raw(Json.Serialize(Model.ChartData)),
                    borderColor: primaryColor,
                    backgroundColor: 'rgba(79, 70, 229, 0.05)',
                    fill: true,
                    tension: 0.45,
                    borderWidth: 3.5,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: primaryColor,
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#fff',
                        titleColor: '#1e293b',
                        bodyColor: '#1e293b',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#f1f5f9', drawBorder: false },
                        ticks: { color: '#64748b', font: { size: 10 } }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#64748b', font: { size: 10 } }
                    }
                }
            }
        });

        // Retention Chart Initialization
        const ctxRetention = document.getElementById('retentionChart').getContext('2d');
        new Chart(ctxRetention, {
            type: 'doughnut',
            data: {
                labels: ['New Patrons', 'Returning Patrons'],
                datasets: [{
                    data: [@Model.NewCustomersCount, @Model.ReturningCustomersCount],
                    backgroundColor: ['#e2e8f0', primaryColor],
                    borderWidth: 8,
                    borderColor: '#fff',
                    hoverOffset: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 25,
                            font: { size: 11, weight: 'bold' },
                            color: '#64748b'
                        }
                    }
                }
            }
        });

        async function generateReward(customerId) {
            if (!confirm('Provision a strategic 15% incentive for this customer?')) return;
            
            try {
                const response = await fetch('@Url.Action("GenerateReward", "Marketing")?customerId=' + customerId, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Provisioned! Automated Promo Code: ' + data.promoCode);
                } else {
                    alert(data.message);
                }
            } catch (err) {
                alert('Network error during reward provisioning.');
            }
        }
    </script>
}

<style>
    .x-small { font-size: 0.75rem; }
    .tracking-wider { letter-spacing: 0.05em; }
    .shadow-sm-hover:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1) !important; transform: translateY(-2px); }
</style>
