@model dynamic
@{
    ViewData["Title"] = "Marketing Dashboard";
}

<div class="marketing-dashboard py-4">
    <!-- Quick Stats (Standardized) -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card-custom border-0 shadow-sm transition-hover" style="background: linear-gradient(135deg, white 0%, #f1f5f9 100%); border-radius: 1.25rem;">
                <div class="card-body p-4 text-center">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary mx-auto mb-3" style="width: 52px; height: 52px; border-radius: 1rem; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-friends fa-lg"></i>
                    </div>
                    <p class="text-secondary small fw-bold text-uppercase mb-1">Total Reach</p>
                    <h2 class="fw-bold mb-1">@Model.TotalCustomers</h2>
                    <div class="text-success x-small fw-bold"><i class="fas fa-caret-up me-1"></i>+12% growth</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-custom border-0 shadow-sm transition-hover" style="background: linear-gradient(135deg, white 0%, #f0fdf4 100%); border-radius: 1.25rem;">
                <div class="card-body p-4 text-center">
                    <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto mb-3" style="width: 52px; height: 52px; border-radius: 1rem; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-tags fa-lg"></i>
                    </div>
                    <p class="text-secondary small fw-bold text-uppercase mb-1">Active Offers</p>
                    <h2 class="fw-bold mb-1">@Model.ActivePromotions</h2>
                    <div class="text-success x-small fw-bold"><i class="fas fa-bullhorn me-1"></i>Live status</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-custom border-0 shadow-sm transition-hover" style="background: linear-gradient(135deg, white 0%, #fff7ed 100%); border-radius: 1.25rem;">
                <div class="card-body p-4 text-center">
                    <div class="stat-icon bg-warning bg-opacity-10 text-warning mx-auto mb-3" style="width: 52px; height: 52px; border-radius: 1rem; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-star fa-lg"></i>
                    </div>
                    <p class="text-secondary small fw-bold text-uppercase mb-1">Loyalty Points</p>
                    <h2 class="fw-bold mb-1">@Model.TotalPointsAwarded</h2>
                    <div class="text-muted x-small">System-wide total</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-custom border-0 shadow-sm transition-hover" style="background: linear-gradient(135deg, white 0%, #f0f9ff 100%); border-radius: 1.25rem;">
                <div class="card-body p-4 text-center">
                    <div class="stat-icon bg-info bg-opacity-10 text-info mx-auto mb-3" style="width: 52px; height: 52px; border-radius: 1rem; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-chart-line fa-lg"></i>
                    </div>
                    <p class="text-secondary small fw-bold text-uppercase mb-1">Conversions</p>
                    <h2 class="fw-bold mb-1">@Model.TotalOrders</h2>
                    <div class="text-success x-small fw-bold"><i class="fas fa-caret-up me-1"></i>+4.2% shift</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between">
                    <h5 class="fw-bold">Campaign Performance</h5>
                    <span class="x-small text-muted">Weekly Transaction Volume</span>
                </div>
                <div class="card-body p-4">
                    <canvas id="performanceChart" style="min-height: 300px; width: 100%;"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Top Customers -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="fw-bold">Most Loyal Customers</h5>
                </div>
                <div class="card-body px-0">
                    <div class="list-group list-group-flush">
                        @foreach (var customer in Model.TopCustomers)
                        {
                            <div class="list-group-item border-0 py-3 px-4 d-flex align-items-center gap-3 transition-hover">
                                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width: 40px; height: 40px;">
                                    @customer.FullName.Substring(0, 1)
                                </div>
                                <div class="flex-fill">
                                    <p class="mb-0 fw-bold">@customer.FullName</p>
                                    <small class="text-muted">@customer.Points Points</small>
                                </div>
                                <button class="btn btn-sm btn-outline-success rounded-pill px-3" onclick="generateReward(@customer.CustomerID)">
                                    <i class="fas fa-gift me-1"></i>Reward
                                </button>
                            </div>
                        }
                    </div>
                </div>
                <div class="card-footer bg-white border-0 text-center pb-4">
                    <a asp-action="Customers" class="text-decoration-none small fw-bold">View All Customers <i class="fas fa-chevron-right ms-1"></i></a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Performance Chart Initialization
        const ctx = document.getElementById('performanceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.ChartLabels)),
                datasets: [{
                    label: 'Transactions',
                    data: @Html.Raw(Json.Serialize(Model.ChartData)),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#4f46e5',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });

        async function generateReward(customerId) {
            if (!confirm('Generate a 15% discount promo code for this customer?')) return;
            
            try {
                const response = await fetch('@Url.Action("GenerateReward", "Marketing")?customerId=' + customerId, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Success! Code: ' + data.promoCode + '\n' + data.message);
                } else {
                    alert(data.message);
                }
            } catch (err) {
                alert('Error generating reward.');
            }
        }
    </script>
}

