@model IEnumerable<ljp_itsolutions.Models.Promotion>
@{
    Layout = "_Layout";
    ViewData["Title"] = "Campaigns & Active Offers";
}

<div class="container-fluid py-2">
    <!-- Action & Filter Bar -->
    <div class="row g-3 mb-4 align-items-center">
        <div class="col-md-4">
            <div class="input-group shadow-sm rounded-pill overflow-hidden border bg-white text-dark">
                <span class="input-group-text bg-transparent border-0 ps-3">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="promoSearch" class="form-control border-0 shadow-none ps-2 py-2" placeholder="Search campaigns...">
            </div>
        </div>
        <div class="col-md-3">
            <select id="statusFilter" class="form-select shadow-sm rounded-pill border py-2">
                <option value="">All Statuses</option>
                <option value="Active">Active Now</option>
                <option value="Scheduled">Scheduled</option>
                <option value="Ended">Ended/Paused</option>
            </select>
        </div>
        <div class="col text-end">
            <button class="btn btn-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                <i class="fas fa-bullhorn me-2"></i>Provision Campaign
            </button>
        </div>
    </div>

    <div class="row g-4" id="promoContainer">
        @foreach (var promo in Model)
        {
            var isEnded = promo.EndDate < DateTime.Now;
            var isUpcoming = promo.StartDate > DateTime.Now;
            var status = promo.IsActive ? (isEnded ? "Ended" : (isUpcoming ? "Scheduled" : "Active")) : "Ended";
            var statusClass = status == "Active" ? "bg-success" : (status == "Scheduled" ? "bg-info" : "bg-secondary");

            <div class="col-xl-4 col-md-6 promo-item" data-status="@status">
                <div class="card border-0 shadow-sm rounded-4 h-100 transition-hover overflow-hidden border-top-glow" 
                     style="--glow-color: @(status == "Active" ? "var(--success-color)" : (status == "Scheduled" ? "var(--info-color)" : "#94a3b8"));">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-fill pe-3">
                                <h6 class="fw-bold text-dark mb-1 search-title">@promo.PromotionName</h6>
                                <p class="text-muted x-small mb-0">Code: <span class="fw-bold text-primary">@promo.PromotionName.Replace(" ", "").ToUpper()</span></p>
                            </div>
                            <div class="d-flex flex-column gap-2 align-items-end">
                                @{
                                    var approvalBadge = promo.ApprovalStatus == "Approved" ? "bg-success" : 
                                                       (promo.ApprovalStatus == "Rejected" ? "bg-danger" : "bg-warning");
                                    var approvalIcon = promo.ApprovalStatus == "Approved" ? "fa-check-circle" : 
                                                      (promo.ApprovalStatus == "Rejected" ? "fa-times-circle" : "fa-clock");
                                }
                                <span class="badge rounded-pill @approvalBadge px-3 x-small">
                                    <i class="fas @approvalIcon me-1"></i>@promo.ApprovalStatus.ToUpper()
                                </span>
                                @if (promo.ApprovalStatus == "Approved")
                                {
                                    <span class="badge rounded-pill @statusClass px-3 x-small">@status.ToUpper()</span>
                                }
                            </div>
                        </div>
                        
                        @if (promo.ApprovalStatus == "Rejected" && !string.IsNullOrEmpty(promo.RejectionReason))
                        {
                            <div class="alert alert-danger border-0 bg-danger bg-opacity-10 p-2 mb-3">
                                <small class="text-danger d-flex align-items-start gap-2">
                                    <i class="fas fa-exclamation-triangle mt-1"></i>
                                    <span><strong>Rejected:</strong> @promo.RejectionReason</span>
                                </small>
                            </div>
                        }
                        else if (promo.ApprovalStatus == "Pending")
                        {
                            <div class="alert alert-warning border-0 bg-warning bg-opacity-10 p-2 mb-3">
                                <small class="text-warning d-flex align-items-center gap-2">
                                    <i class="fas fa-hourglass-half"></i>
                                    <span>Awaiting manager approval to activate in POS</span>
                                </small>
                            </div>
                        }
                        
                        <div class="promo-discount-display p-3 bg-light rounded-4 mb-4 text-center border border-white shadow-sm border-2">
                            <span class="h1 fw-bold text-primary mb-0">
                                @(promo.DiscountType == "Percentage" ? $"{promo.DiscountValue}%" : $"₱{promo.DiscountValue}")
                            </span>
                            <span class="fw-bold text-muted small ms-1 uppercase tracking-wider">Discount</span>
                        </div>

                        <div class="promo-meta mb-4">
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="d-flex align-items-center gap-2 p-2 bg-white rounded-3 small">
                                        <i class="far fa-calendar-alt text-primary opacity-50"></i>
                                        <span class="text-dark fw-medium">@promo.StartDate.ToString("MMM dd") — @promo.EndDate.ToString("MMM dd, yyyy")</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-light border-0 flex-fill btn-sm rounded-pill py-2 fw-bold shadow-none edit-promo-btn"
                                    data-id="@promo.PromotionID"
                                    data-name="@promo.PromotionName"
                                    data-type="@promo.DiscountType"
                                    data-value="@promo.DiscountValue"
                                    data-start="@promo.StartDate.ToString("yyyy-MM-dd")"
                                    data-end="@promo.EndDate.ToString("yyyy-MM-dd")"
                                    data-active="@promo.IsActive.ToString().ToLower()">
                                Modify
                            </button>
                            <form asp-action="DeleteCampaign" method="post" onsubmit="return confirm('Delete this campaign?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@promo.PromotionID" />
                                <button type="submit" class="btn btn-white border flex-fill btn-sm rounded-pill py-2 fw-bold text-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            <a asp-action="PromotionPerformance" class="btn btn-white border flex-fill btn-sm rounded-pill py-2 fw-bold text-primary hvr-light">
                                <i class="fas fa-chart-pie me-1 x-small opacity-50"></i> Analytics
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Create Campaign Modal -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0 py-4">
                <h5 class="modal-title fw-bold">Provision New Campaign</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form asp-action="CreateCampaign" method="post" id="campaignForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-4">
                        <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Campaign Name</label>
                        <input name="PromotionName" class="form-control rounded-3" required />
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Discount Type</label>
                            <select name="DiscountType" class="form-select rounded-3">
                                <option value="Percentage">Percentage (%)</option>
                                <option value="Fixed">Fixed Amount (₱)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Face Value</label>
                            <input name="DiscountValue" type="number" step="0.01" class="form-control rounded-3" required />
                        </div>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Start Date</label>
                            <input name="StartDate" type="date" class="form-control rounded-3" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">End Date</label>
                            <input name="EndDate" type="date" class="form-control rounded-3" value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")" required />
                        </div>
                    </div>
                    <div class="form-check form-switch p-3 bg-light rounded-3">
                        <input class="form-check-input ms-0 me-2" name="IsActive" type="checkbox" checked value="true">
                        <label class="form-check-label small fw-bold">Activate Campaign upon Approval</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="campaignForm" class="btn btn-primary rounded-pill px-4">Create Campaign</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Campaign Modal -->
<div class="modal fade" id="editCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0 py-4">
                <h5 class="modal-title fw-bold">Modify Strategic Campaign</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form asp-action="EditCampaign" method="post" id="editCampaignForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="PromotionID" id="edit-promo-id" />
                    <div class="mb-4">
                        <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Campaign Name</label>
                        <input name="PromotionName" id="edit-promo-name" class="form-control rounded-3" required />
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Discount Type</label>
                            <select name="DiscountType" id="edit-promo-type" class="form-select rounded-3">
                                <option value="Percentage">Percentage (%)</option>
                                <option value="Fixed">Fixed Amount (₱)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Face Value</label>
                            <input name="DiscountValue" id="edit-promo-value" type="number" step="0.01" class="form-control rounded-3" required />
                        </div>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">Start Date</label>
                            <input name="StartDate" id="edit-promo-start" type="date" class="form-control rounded-3" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small fw-bold text-muted uppercase tracking-wider">End Date</label>
                            <input name="EndDate" id="edit-promo-end" type="date" class="form-control rounded-3" required />
                        </div>
                    </div>
                    <div class="form-check form-switch p-3 bg-light rounded-3">
                        <input class="form-check-input ms-0 me-2" name="IsActive" id="edit-promo-active" type="checkbox" value="true">
                        <label class="form-check-label small fw-bold">Active Initiative</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editCampaignForm" class="btn btn-primary rounded-pill px-4">Update and Resubmit</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            function filterPromos() {
                var searchTerm = $('#promoSearch').val().toLowerCase();
                var statusFilter = $('#statusFilter').val();

                $('.promo-item').each(function() {
                    var item = $(this);
                    var title = item.find('.search-title').text().toLowerCase();
                    var code = item.find('p.text-muted span').text().toLowerCase();
                    var status = item.data('status');

                    var matchesSearch = title.includes(searchTerm) || code.includes(searchTerm);
                    var matchesStatus = statusFilter === "" || status === statusFilter;

                    if (matchesSearch && matchesStatus) {
                        item.show();
                    } else {
                        item.hide();
                    }
                });

                if ($('.promo-item:visible').length === 0) {
                    if ($('#noResults').length === 0) {
                        $('#promoContainer').append('<div id="noResults" class="col-12 text-center py-5 text-muted"><i class="fas fa-bullhorn fa-3x mb-3 opacity-25"></i><p>No campaigns match your specific criteria.</p></div>');
                    }
                } else {
                    $('#noResults').remove();
                }
            }

            $('#promoSearch').on('keyup', filterPromos);
            $('#statusFilter').on('change', filterPromos);

            $('.edit-promo-btn').click(function() {
                const id = $(this).data('id');
                const name = $(this).data('name');
                const type = $(this).data('type');
                const value = $(this).data('value');
                const start = $(this).data('start');
                const end = $(this).data('end');
                const active = $(this).data('active');

                $('#edit-promo-id').val(id);
                $('#edit-promo-name').val(name);
                $('#edit-promo-type').val(type);
                $('#edit-promo-value').val(value);
                $('#edit-promo-start').val(start);
                $('#edit-promo-end').val(end);
                $('#edit-promo-active').prop('checked', active);

                new bootstrap.Modal(document.getElementById('editCampaignModal')).show();
            });
        });
    </script>
}

<style>
    .border-top-glow { border-top: 4px solid var(--glow-color) !important; }
    .x-small { font-size: 0.75rem; }
    .uppercase { text-transform: uppercase; }
    .tracking-wider { letter-spacing: 0.1em; }
    .hvr-light:hover { background-color: #f8fafc !important; border-color: #e2e8f0 !important; }
</style>
