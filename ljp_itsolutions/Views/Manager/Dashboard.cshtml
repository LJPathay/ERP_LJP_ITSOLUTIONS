@model ljp_itsolutions.Services.ManagerDashboardData
@{
    ViewData["Title"] = "Manager Dashboard";
    Layout = "_Layout";
}

<div class="container-fluid px-4 py-3">


    <!-- Top KPI Strip -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="kpi-card-premium brand-primary">
                <div class="kpi-content">
                    <p class="kpi-title">Gross Operating Revenue</p>
                    <span class="kpi-main-val">₱@Model.TotalRevenue.ToString("N0")</span>
                    <div class="kpi-trend @(Model.RevenueGrowth >= 0 ? "text-success" : "text-danger")">
                        <i class="fas @(Model.RevenueGrowth >= 0 ? "fa-arrow-up" : "fa-arrow-down")"></i>
                        @Math.Abs(Model.RevenueGrowth).ToString("N1")% vs Last Week
                    </div>
                </div>
                <div class="kpi-icon-box">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card-premium brand-success">
                <div class="kpi-content">
                    <p class="kpi-title">Average Order Value (AOV)</p>
                    <span class="kpi-main-val">₱@Model.AvgOrderValue.ToString("N2")</span>
                    <div class="kpi-trend text-muted">
                        Unit Efficiency
                    </div>
                </div>
                <div class="kpi-icon-box">
                    <i class="fas fa-receipt"></i>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card-premium brand-danger">
                <div class="kpi-content">
                    <p class="kpi-title">Critical Stock Alerts</p>
                    <span class="kpi-main-val">@Model.LowStockIngredients.Count()</span>
                    <div class="kpi-trend text-danger">
                        Immediate Action Needed
                    </div>
                </div>
                <div class="kpi-icon-box">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card-premium brand-warning">
                <div class="kpi-content">
                    <p class="kpi-title">Inventory Turn</p>
                    <span class="kpi-main-val">@Model.TotalProducts</span>
                    <div class="kpi-trend text-muted">
                        Active Managed SKU's
                    </div>
                </div>
                <div class="kpi-icon-box">
                    <i class="fas fa-box-open"></i>
                </div>
            </div>
        </div>
    </div>



    <!-- Main Content Grid -->
    <div class="row g-4 mb-4">
        <!-- Sales Velocity -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
                <div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0">Sales Performance Velocity</h6>
                    <div class="badge bg-light text-dark border">7 Day Window</div>
                </div>
                <div class="card-body p-4">
                    <div style="height: 300px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100 bg-white">
                <div class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark">Critical Operational Alerts</h6>
                    <span class="badge bg-light text-muted fw-normal">Priority</span>
                </div>
                <div class="card-body p-4 pt-0">
                    <div class="alert-list">
                        @foreach (var alert in Model.LowStockIngredients)
                        {
                            <div class="d-flex align-items-center gap-3 p-3 mb-2 rounded-3 hover-bg-light transition-all border border-light">
                                <div class="alert-icon bg-light text-dark rounded-circle d-flex align-items-center justify-content-center border" style="width: 36px; height: 36px;">
                                    <i class="fas fa-exclamation-triangle small"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0 fw-bold small text-dark">@alert.Name (Low Stock)</p>
                                    <p class="text-muted xx-small mb-0">Balance: @alert.StockQuantity.ToString("N1") @alert.Unit</p>
                                </div>
                                <a asp-action="Inventory" class="btn btn-sm btn-light border-0 rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    <i class="fas fa-shopping-cart text-primary xx-small"></i>
                                </a>
                            </div>
                        }
                        @if (!Model.LowStockIngredients.Any())
                        {
                            <div class="text-center py-5">
                                <i class="fas fa-check-double fa-3x text-success opacity-25 mb-3"></i>
                                <p class="small text-muted">Operational integrity is optimal. No critical inventory alerts.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Insights Row -->
    <div class="row g-4">
        <!-- Peak Hours -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white py-3 px-4">
                    <h6 class="fw-bold mb-0">Consumer Throughput Analysis (Peak Hours)</h6>
                </div>
                <div class="card-body p-4">
                    <div style="height: 250px;">
                        <canvas id="peakHoursChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Logs -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0">Recent Operational Logs</h6>
                    <a asp-action="Transactions" class="text-primary xx-small fw-bold text-decoration-none">Full Audit <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 border-0 x-small fw-bold">ID</th>
                                    <th class="border-0 x-small fw-bold">Value</th>
                                    <th class="border-0 x-small fw-bold">Status</th>
                                    <th class="border-0 x-small fw-bold text-end pe-4">Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in Model.RecentOrders.Take(5))
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <span class="small fw-bold">#@order.OrderID.ToString().Substring(0, 5)</span>
                                        </td>
                                        <td><span class="small fw-semibold">₱@order.FinalAmount.ToString("N2")</span></td>
                                        <td>
                                            <span class="badge @(order.PaymentStatus == "Paid" ? "bg-success" : "bg-warning") bg-opacity-10 @(order.PaymentStatus == "Paid" ? "text-success" : "text-warning") border rounded-pill xx-small">@order.PaymentStatus</span>
                                        </td>
                                        <td class="text-end pe-4"><span class="text-muted xx-small">@order.OrderDate.ToString("t")</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .kpi-card { transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px -3px rgba(0,0,0,0.1) !important; }
    .kpi-icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; color: rgba(0,0,0,0.03); transform: rotate(-15deg); pointer-events: none; }
    .bg-soft-blue { background-color: rgba(59, 130, 246, 0.1); }
    .hover-bg-light:hover { background-color: #f8fafc; cursor: pointer; }
    .transition-all { transition: all 0.2s ease; }
    .xx-small { font-size: 0.65rem; }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Line Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.DailyRevenueLabels)),
                datasets: [{
                    label: 'Revenue Volume',
                    data: @Html.Raw(Json.Serialize(Model.DailyRevenueData)),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.05)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] }, ticks: { callback: (v) => '₱' + v } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Peak Hours Bar
        const peakCtx = document.getElementById('peakHoursChart').getContext('2d');
        new Chart(peakCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.PeakHoursLabels)),
                datasets: [{
                    data: @Html.Raw(Json.Serialize(Model.PeakHoursData)),
                    backgroundColor: '#1e293b',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    </script>
}
