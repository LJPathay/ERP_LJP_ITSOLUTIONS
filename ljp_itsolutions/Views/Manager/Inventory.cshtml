@model ljp_itsolutions.Models.InventoryViewModel
@{
    ViewData["Title"] = "Inventory Management";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container .select2-selection--single {
            height: 38px !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 0.375rem !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px !important;
        }
    </style>
}

<div class="container-fluid py-4">

    <!-- KPI Summary Row -->
    <div class="row g-3 mb-4">
        <!-- Total Items -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid #3b82f6 !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Total Items</p>
                            <h4 class="fw-bold mb-0">@Model.Ingredients.Count</h4>
                            <span class="text-muted xx-small">Stocked Ingredients</span>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-3 p-2 text-primary">
                            <i class="fas fa-cubes"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Critical Items -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid @(Model.OutOfStockCount > 0 ? "#ef4444" : "#10b981") !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Critical</p>
                            <h4 class="fw-bold mb-0 @(Model.OutOfStockCount > 0 ? "text-danger" : "text-success")">@Model.OutOfStockCount</h4>
                            <span class="@(Model.OutOfStockCount > 0 ? "text-danger" : "text-muted") xx-small">@(Model.OutOfStockCount > 0 ? "Needs Urgent Reorder" : "Stock Levels Stable")</span>
                        </div>
                        <div class="@(Model.OutOfStockCount > 0 ? "bg-danger" : "bg-success") bg-opacity-10 rounded-3 p-2 @(Model.OutOfStockCount > 0 ? "text-danger" : "text-success")">
                            <i class="fas @(Model.OutOfStockCount > 0 ? "fa-exclamation-triangle" : "fa-check-circle")"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Low Stock Items -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid @(Model.LowStockCount > 0 ? "#f59e0b" : "#3b82f6") !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Low Stock</p>
                            <h4 class="fw-bold mb-0 @(Model.LowStockCount > 0 ? "text-warning" : "text-primary")">@Model.LowStockCount</h4>
                            <span class="@(Model.LowStockCount > 0 ? "text-warning" : "text-muted") xx-small">@(Model.LowStockCount > 0 ? "Below Threshold" : "Healthy Buffer")</span>
                        </div>
                        <div class="@(Model.LowStockCount > 0 ? "bg-warning" : "bg-primary") bg-opacity-10 rounded-3 p-2 @(Model.LowStockCount > 0 ? "text-warning" : "text-primary")">
                            <i class="fas @(Model.LowStockCount > 0 ? "fa-arrow-down" : "fa-shield-alt")"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Healthy Stock Items -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden" style="border-left: 3px solid #10b981 !important;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted x-small fw-bold text-uppercase tracking-wider mb-1">Healthy</p>
                            <h4 class="fw-bold mb-0 text-success">@Model.HealthyStockCount</h4>
                            <span class="text-success xx-small">Optimal Levels</span>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-3 p-2 text-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 p-3 bg-white">
        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
            <div class="input-group" style="max-width: 300px;">
                <span class="input-group-text bg-light border-end-0 text-muted"><i class="fas fa-search"></i></span>
                <input type="text" id="inventorySearch" class="form-control bg-light border-start-0" placeholder="Search ingredients...">
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#stockIntakeModal">
                    <i class="fas fa-truck-loading me-2"></i>Stock Intake
                </button>
                <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addIngredientModal">
                    <i class="fas fa-plus me-2"></i>Add Ingredient
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="inventoryTable">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-uppercase x-small fw-bold text-muted">Item Name</th>
                        <th class="py-3 text-uppercase x-small fw-bold text-muted">Unit</th>
                        <th class="py-3 text-uppercase x-small fw-bold text-muted" style="width: 30%;">Stock Level</th>
                        <th class="py-3 text-uppercase x-small fw-bold text-muted">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Ingredients.Any())
                    {
                        foreach (var item in Model.Ingredients)
                        {
                            var stockPercent = Math.Min(100, (double)item.StockQuantity / ((double)item.LowStockThreshold * 3) * 100);
                            string colorClass = "success";
                            string statusText = "In Stock";
                            
                            if (item.StockQuantity < 0)
                            {
                                colorClass = "danger";
                                statusText = "Critical";
                            }
                            else if (item.StockQuantity == 0)
                            {
                                colorClass = "danger";
                                statusText = "Out of Stock";
                            }
                            else if (item.StockQuantity < item.LowStockThreshold)
                            {
                                colorClass = "warning";
                                statusText = "Low Stock";
                            }

                            <tr style="cursor: pointer;" onclick="loadIngredientDetails(@item.IngredientID)" class="ingredient-row">
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">@item.Name</div>
                                    <div class="text-muted x-small">ID: #@item.IngredientID</div>
                                </td>
                                <td class="text-muted small">@item.Unit</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="progress flex-grow-1" style="height: 6px;">
                                            <div class="progress-bar bg-@colorClass" role="progressbar" style="width: @stockPercent%"></div>
                                        </div>
                                        <span class="x-small fw-bold text-muted" style="width: 60px;">
                                            @item.StockQuantity.ToString("N1") / @((item.LowStockThreshold * 3).ToString("N1"))
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge rounded-pill bg-@colorClass bg-opacity-10 text-@colorClass border border-@colorClass border-opacity-10 px-3">
                                        @statusText
                                    </span>
                                </td>
                                <!-- Hidden button for Edit Modal triggering -->
                                <td class="d-none">
                                    <button class="btn-edit-ingredient d-none" 
                                            data-id="@item.IngredientID"
                                            data-name="@item.Name"
                                            data-stock="@item.StockQuantity"
                                            data-unit="@item.Unit"
                                            data-threshold="@item.LowStockThreshold"
                                            data-expiry="@(item.ExpiryDate?.ToString("yyyy-MM-dd"))"></button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <div class="py-5">
                                    <i class="fas fa-box-open fa-4x text-muted opacity-25 mb-4"></i>
                                    <h6 class="fw-bold text-dark">Inventory Empty</h6>
                                    <p class="text-muted small">No ingredients found in the inventory.</p>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center p-3 bg-light border-top">
            <div class="text-muted x-small">
                Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span id="totalItems">0</span> items
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination">
                    <!-- Pagination buttons will be injected here -->
                </ul>
            </nav>
        </div>
    </div>

</div>
</div>

<!-- Add Ingredient Modal -->
<div class="modal fade" id="addIngredientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 pb-0 pt-4 px-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-primary">
                        <i class="fas fa-box-open fw-bold"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bolder text-dark mb-0">New Ingredient</h5>
                        <p class="text-muted small mb-0 uppercase tracking-widest">Create Item</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 pt-3">
                <form asp-action="CreateIngredient" method="post">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Ingredient Name</label>
                        <input type="text" name="Name" class="form-control bg-light border-0 py-2" required placeholder="e.g. Fresh Milk" />
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted uppercase">Initial Stock</label>
                            <input type="number" step="0.001" name="StockQuantity" class="form-control bg-light border-0 py-2" required value="0" />
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted uppercase">Unit</label>
                            <select name="Unit" class="form-select bg-light border-0 py-2" required>
                                <option value="kg">kg (Kilogram)</option>
                                <option value="L">L (Liter)</option>
                                <option value="ml">ml (Milliliter)</option>
                                <option value="g">g (Gram)</option>
                                <option value="pcs">pcs (Pieces)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Low Stock Threshold</label>
                        <input type="number" step="0.001" name="LowStockThreshold" class="form-control bg-light border-0 py-2" required value="1" />
                        <div class="form-text x-small text-muted mt-1"><i class="fas fa-info-circle me-1"></i>You'll be notified when stock falls below this level.</div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted uppercase">Expiry Date (Optional)</label>
                        <input type="date" name="ExpiryDate" class="form-control bg-light border-0 py-2" />
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold py-3 shadow-sm">
                            <i class="fas fa-plus me-2"></i>Create Ingredient
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ingredient Modal -->
<div class="modal fade" id="editIngredientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 pb-0 pt-4 px-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-sm bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-warning">
                        <i class="fas fa-edit fw-bold"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bolder text-dark mb-0">Edit Ingredient</h5>
                        <p class="text-muted small mb-0 uppercase tracking-widest">Update Details</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 pt-3">
                <form asp-action="EditIngredient" method="post">
                    <input type="hidden" name="IngredientID" id="edit-ing-id" />
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Ingredient Name</label>
                        <input type="text" name="Name" id="edit-ing-name" class="form-control bg-light border-0 py-2" required />
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted uppercase">Update Stock</label>
                            <input type="number" step="0.001" name="StockQuantity" id="edit-ing-stock" class="form-control bg-light border-0 py-2" required />
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted uppercase">Unit</label>
                            <select name="Unit" id="edit-ing-unit" class="form-select bg-light border-0 py-2" required>
                                <option value="kg">kg</option>
                                <option value="L">L</option>
                                <option value="ml">ml</option>
                                <option value="g">g</option>
                                <option value="pcs">pcs</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Low Stock Threshold</label>
                        <input type="number" step="0.001" name="LowStockThreshold" id="edit-ing-threshold" class="form-control bg-light border-0 py-2" required />
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted uppercase">Expiry Date (Optional)</label>
                        <input type="date" name="ExpiryDate" id="edit-ing-expiry" class="form-control bg-light border-0 py-2" />
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold py-3 shadow-sm">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Stock Intake Modal -->
<div class="modal fade" id="stockIntakeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 pb-0 pt-4 px-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-sm bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-success">
                        <i class="fas fa-plus fw-bold"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bolder text-dark mb-0">Stock Intake</h5>
                        <p class="text-muted small mb-0 uppercase tracking-widest">Restock Inventory</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 pt-3">
                <form asp-action="IntakeStock" method="post">
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted uppercase">Select Ingredient</label>
                        <select name="IngredientID" id="intake-ing-id" class="form-select select2 bg-light border-0" required style="width: 100%; padding: 0.75rem;">
                            <option value="">-- Choose Ingredient --</option>
                            @foreach (var ing in Model.Ingredients.OrderBy(i => i.Name))
                            {
                                <option value="@ing.IngredientID" data-unit="@ing.Unit">@ing.Name (@ing.StockQuantity.ToString("N2") @ing.Unit available)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Quantity to Add</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0 text-muted ps-3"><i class="fas fa-balance-scale"></i></span>
                            <input type="number" step="0.001" name="Quantity" class="form-control bg-light border-0 py-2" required placeholder="0.00" />
                            <span class="input-group-text bg-light border-0 text-muted pe-3 fw-bold" id="intake-unit-badge">unit</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Intake Date</label>
                        <input type="date" name="IntakeDate" id="intake-date" class="form-control bg-light border-0 py-2" required />
                        <div class="form-text x-small text-muted mt-1"><i class="fas fa-clock me-1"></i>Date of physical stocking</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Expiry Date (Optional)</label>
                        <input type="date" name="ExpiryDate" id="intake-expiry" class="form-control bg-light border-0 py-2" />
                        <div class="form-text x-small text-muted mt-1"><i class="fas fa-calendar-times me-1"></i>New expiry date for this batch</div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted uppercase">Remarks</label>
                        <textarea name="Remarks" class="form-control bg-light border-0 py-2" rows="3" placeholder="e.g. Weekly restock from supplier X" maxlength="200"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill fw-bold py-3 shadow-sm">
                            <i class="fas fa-check me-2"></i>Process Intake
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Ingredient Details Modal -->
<div class="modal fade" id="ingredientDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 pb-0 pt-4 px-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-primary" style="width: 48px; height: 48px;">
                        <i class="fas fa-cube fw-bold"></i>
                    </div>
                    <div>
                        <h4 class="modal-title fw-bolder text-dark mb-0"><span id="detail-name">Ingredient</span></h4>
                        <p class="text-muted small mb-0 uppercase tracking-widest">Inventory Details</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4 bg-white">
                <!-- Quick Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="p-3 bg-light rounded-4 text-center h-100 border-0">
                            <small class="text-muted d-block mb-1 uppercase fw-bold x-small">Current Stock</small>
                            <div class="h5 fw-bold text-dark mb-0"><span id="detail-stock">0</span></div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-3 bg-light rounded-4 text-center h-100 border-0">
                            <small class="text-muted d-block mb-1 uppercase fw-bold x-small">Threshold</small>
                            <div class="h5 fw-bold text-dark mb-0" id="detail-threshold">0</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-3 bg-light rounded-4 text-center h-100 border-0">
                            <small class="text-muted d-block mb-1 uppercase fw-bold x-small">Last Stocked</small>
                            <div class="h6 fw-bold text-dark mb-0" id="detail-last-stocked">Never</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-3 bg-light rounded-4 text-center h-100 border-0">
                            <small class="text-muted d-block mb-1 uppercase fw-bold x-small">Expiry</small>
                            <div class="h6 fw-bold text-dark mb-0" id="detail-expiry">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Actions Panel -->
                    <div class="col-lg-4">
                        <div class="pe-lg-3">
                            <h6 class="fw-bold text-dark mb-3 d-flex align-items-center">
                                <span class="bg-primary bg-opacity-10 p-2 rounded-3 me-2" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-cogs text-primary small"></i>
                                </span>
                                Actions
                            </h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-light fw-bold py-2 text-start px-3 rounded-pill btn-edit-from-detail">
                                    <i class="fas fa-edit me-2 text-primary"></i> Edit Details
                                </button>
                                <button class="btn btn-primary fw-bold py-2 text-start px-3 rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#stockIntakeModal">
                                    <i class="fas fa-plus-circle me-2"></i> Add Stock
                                </button>
                            </div>
                            
                            <div class="mt-4 p-3 bg-light rounded-4 border-0">
                                <small class="text-muted d-block mb-2 fw-bold text-uppercase x-small">Status</small>
                                <div id="detail-status-badge"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Panel -->
                    <div class="col-lg-8 border-start-lg">
                        <h6 class="fw-bold text-dark mb-3 d-flex align-items-center">
                            <span class="bg-primary bg-opacity-10 p-2 rounded-3 me-2" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;">
                                <i class="fas fa-history text-primary small"></i>
                            </span>
                            Recent Activity
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <tbody id="detail-logs-body" class="small border-top-0">
                                    <!-- Logs will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer border-0 px-4 pb-4 pt-0 bg-white">
                <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                dropdownParent: $('#stockIntakeModal')
            });

            // Pagination state
            let currentPage = 1;
            const rowsPerPage = 10;
            let filteredRows = [];

            function initPagination() {
                const rows = Array.from(document.querySelectorAll('#inventoryTable tbody tr.ingredient-row'));
                filteredRows = rows;
                updatePagination();
            }

            function updatePagination() {
                const totalItems = filteredRows.length;
                const totalPages = Math.ceil(totalItems / rowsPerPage);
                
                if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;

                // Hide all rows
                document.querySelectorAll('#inventoryTable tbody tr.ingredient-row').forEach(row => row.style.display = 'none');
                
                // Show filtered
                filteredRows.slice(start, end).forEach(row => row.style.display = '');

                // Update range text
                if (totalItems > 0) {
                    document.getElementById('startRange').textContent = start + 1;
                    document.getElementById('endRange').textContent = Math.min(end, totalItems);
                    document.getElementById('totalItems').textContent = totalItems;
                } else {
                    document.getElementById('startRange').textContent = 0;
                    document.getElementById('endRange').textContent = 0;
                    document.getElementById('totalItems').textContent = 0;
                }

                renderPaginationButtons(totalPages);
            }

            function renderPaginationButtons(totalPages) {
                const container = document.getElementById('pagination');
                container.innerHTML = '';
                if (totalPages <= 1) return;

                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left x-small"></i></a>`;
                container.appendChild(prevLi);

                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                        container.appendChild(li);
                    } else if (i === currentPage - 2 || i === currentPage + 2) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = '<span class="page-link">...</span>';
                        container.appendChild(li);
                    }
                }

                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right x-small"></i></a>`;
                container.appendChild(nextLi);
            }

            window.changePage = function(page) {
                if (page < 1 || page > Math.ceil(filteredRows.length / rowsPerPage)) return;
                currentPage = page;
                updatePagination();
                event.preventDefault();
            };

            // Search functionality with debounce
            let searchTimeoutInvent;
            $('#inventorySearch').on('keyup', function() {
                clearTimeout(searchTimeoutInvent);
                const searchValue = $(this).val().toLowerCase();
                
                searchTimeoutInvent = setTimeout(() => {
                    const allRows = Array.from(document.querySelectorAll('#inventoryTable tbody tr.ingredient-row'));
                    
                    filteredRows = allRows.filter(row => {
                        const text = row.textContent.toLowerCase();
                        return text.includes(searchValue);
                    });
                    
                    currentPage = 1;
                    updatePagination();
                }, 300);
            });

    
            $('#intake-ing-id').on('change', function() {
                var selected = $(this).find('option:selected');
                var unit = selected.data('unit') || 'unit';
                $('#intake-unit-badge').text(unit);
            });

            const today = new Date().toISOString().split('T')[0];
            const intakeDateInput = document.getElementById('intake-date');
            if (intakeDateInput) {
                intakeDateInput.value = today;
                intakeDateInput.min = today; 
            }

            initPagination();

            $(document).on('click', '.btn-edit-ingredient', function(e) {
                e.stopPropagation();
                var id = $(this).data('id');
                var name = $(this).data('name');
                var stock = $(this).data('stock');
                var unit = $(this).data('unit');
                var threshold = $(this).data('threshold');
                var expiry = $(this).data('expiry');

                $('#edit-ing-id').val(id);
                $('#edit-ing-name').val(name);
                $('#edit-ing-stock').val(stock);
                $('#edit-ing-unit').val(unit);
                $('#edit-ing-threshold').val(threshold);
                $('#edit-ing-expiry').val(expiry);

                var modalEl = document.getElementById('editIngredientModal');
                var myModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                myModal.show();
            });

            // Row Click for Details
            $(document).on('click', '.clickable-row', function(e) {
                // Ignore if clicking on a button or something interactive
                if ($(e.target).closest('button, a, input, select').length) return;
                
                var id = $(this).data('id');
                loadIngredientDetails(id);
            });

        });

        async function loadIngredientDetails(id) {
            try {
                const response = await fetch(`/Manager/GetIngredientDetails?id=${id}`);
                const data = await response.json();
                
                if (data) {
                    const ing = data.ingredient;
        const logs = data.logs;
        
        // Update edit button data attributes with fresh server data to prevent stale state
        const editBtn = $(`.btn-edit-ingredient[data-id="${id}"]`);
        if (editBtn.length) {
            editBtn.data('name', ing.name || ing.Name);
            editBtn.data('stock', ing.stockQuantity || ing.StockQuantity);
            editBtn.data('threshold', ing.lowStockThreshold || ing.LowStockThreshold);
            editBtn.data('unit', ing.unit || ing.Unit);
            const rawExpiry = ing.expiryDate || ing.ExpiryDate;
            editBtn.data('expiry', rawExpiry ? rawExpiry.split('T')[0] : '');
        }

        $('#detail-name').text(ing.name || ing.Name);
        $('#detail-stock').text(`${(ing.stockQuantity || ing.StockQuantity || 0).toFixed(2)} ${ing.unit || ing.Unit}`);
                    $('#detail-threshold').text(`${(ing.lowStockThreshold || ing.LowStockThreshold || 0).toFixed(2)} ${ing.unit || ing.Unit}`);
                    $('#detail-last-stocked').text((ing.lastStockedDate || ing.LastStockedDate) ? new Date(ing.lastStockedDate || ing.LastStockedDate).toLocaleDateString() : 'Never');
                    $('#detail-expiry').text((ing.expiryDate || ing.ExpiryDate) ? new Date(ing.expiryDate || ing.ExpiryDate).toLocaleDateString() : 'N/A');

                    // Status Badge Logic
                    const stock = ing.stockQuantity || ing.StockQuantity || 0;
                    const threshold = ing.lowStockThreshold || ing.LowStockThreshold || 0;
                    const statusContainer = $('#detail-status-badge');
                    
                    if (stock < 0) {
                        statusContainer.html('<span class="badge bg-danger rounded-pill px-3 py-2 text-white"><i class="fas fa-exclamation-circle me-2"></i>Critical Stock</span>');
                    } else if (stock == 0) {
                        statusContainer.html('<span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3 py-2"><i class="fas fa-times-circle me-2"></i>Out of Stock</span>');
                    } else if (stock <= threshold) {
                        statusContainer.html('<span class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3 py-2"><i class="fas fa-exclamation-triangle me-2"></i>Low Stock</span>');
                    } else {
                        statusContainer.html('<span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 py-2"><i class="fas fa-check-circle me-2"></i>In Stock</span>');
                    }

                    const logsBody = $('#detail-logs-body');
                    logsBody.empty();

                    if (logs && logs.length > 0) {
                        logs.forEach(log => {
                            const date = new Date(log.logDate).toLocaleDateString();
                            const isPositive = log.quantityChange > 0;
                            const changeColor = isPositive ? 'text-success' : 'text-danger';
                            const prefix = isPositive ? '+' : '';
                            const bgClass = isPositive ? 'bg-success' : 'bg-danger';
                            
                            logsBody.append(`
                                <tr>
                                    <td class="text-muted" style="width: 100px;">${date}</td>
                                    <td style="width: 120px;">
                                        <span class="badge ${bgClass} bg-opacity-10 ${changeColor} rounded-pill px-2">
                                            ${prefix}${log.quantityChange.toFixed(2)}
                                        </span>
                                    </td>
                                    <td class="fw-bold text-dark">${log.changeType}</td>
                                    <td class="text-muted text-break small fst-italic">${log.remarks || '-'}</td>
                                </tr>
                            `);
                        });
                    } else {
                        logsBody.append('<tr><td colspan="4" class="text-center text-muted py-4"><i class="fas fa-history mb-2 d-block opacity-50"></i>No activity logs found.</td></tr>');
                    }

                    // Set up "Edit" button in detail modal
                    $('.btn-edit-from-detail').off('click').on('click', function() {
                        const detailsModalEl = document.getElementById('ingredientDetailsModal');
                        const detailsModal = bootstrap.Modal.getOrCreateInstance(detailsModalEl);
                        
                        detailsModalEl.addEventListener('hidden.bs.modal', function onHidden() {
                            $(`.btn-edit-ingredient[data-id="${id}"]`).click();
                            detailsModalEl.removeEventListener('hidden.bs.modal', onHidden);
                        }, { once: true });
                        
                        detailsModal.hide();
                    });

                    var detailModalEl = document.getElementById('ingredientDetailsModal');
                    var detailModal = bootstrap.Modal.getOrCreateInstance(detailModalEl);
                    detailModal.show();
                }
            } catch (error) {
                console.error('Error loading ingredient details:', error);
            }
        }
    </script>
    </script>
}

<style>
    .x-small { font-size: 0.75rem; }
    
    .bg-primary .modal-title { color: #ffffff !important; }
    .modal-title { color: #000000 !important; font-weight: 800; letter-spacing: -0.02em; }
    
    .rounded-4 { border-radius: 1.25rem !important; }
    .avatar-sm { width: 48px; height: 48px; }
    
    .bg-light { background-color: #f8f9fa !important; border: 1px solid rgba(0,0,0,0.03); }
    
    .form-control:focus, .form-select:focus {
        background-color: #fff !important;
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
        border-color: rgba(var(--bs-primary-rgb), 0.2);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #006aff 0%, #004dc7 100%);
        border: none;
        transition: all 0.2s ease;
    }
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 106, 255, 0.3);
    }
    
    .tracking-widest { letter-spacing: 0.1em; }
    
    @@media (min-width: 992px) {
        .border-start-lg { 
            border-left: 1px solid #eee !important; 
            padding-left: 2rem !important; 
        }
    }
</style>
