@model IEnumerable<ljp_itsolutions.Models.Order>
@{
    ViewData["Title"] = "Transaction Override";
    ViewData["Subtitle"] = "Manager-level control for voiding, refunding, and syncing orders";
    var orders = Model.ToList();
    var totalCount = orders.Count;
    var actionableCount = orders.Count(o => o.PaymentStatus == "Paid" || o.PaymentStatus == "Paid (Digital)");
    var voidedCount = orders.Count(o => o.PaymentStatus == "Voided");
    var refundedCount = orders.Count(o => o.PaymentStatus == "Refunded");
}

@section Styles {
    <style>
        .sticky-action {
            position: sticky;
            right: 0;
            background: white !important;
            box-shadow: -4px 0 8px rgba(0,0,0,0.02);
            z-index: 10;
        }
        thead th.sticky-action {
            background: #f8f9fa !important;
            z-index: 11;
        }
        .tx-row { transition: background 0.15s ease; }
        .tx-row:hover { background: #f8faff !important; }
        .search-input:focus { box-shadow: 0 0 0 0.25rem rgba(0,106,255,0.1); border-color: rgba(0,106,255,0.2); }
        .page-bar { background: #fff; border-top: 1px solid #f0f0f0; }
        .tx-stat-card { border-radius: 1rem; border: 1px solid rgba(0,0,0,0.05); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .tx-stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08) !important; }
    </style>
}

<div class="container-fluid py-4">

    <!-- Quick Stats -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm p-3 tx-stat-card">
                <div class="text-muted small fw-bold mb-1 uppercase" style="font-size:0.7rem; letter-spacing:.1em;">TOTAL</div>
                <div class="fw-bolder h4 mb-0 text-dark" id="stat-total">@totalCount</div>
                <div class="text-muted x-small mt-1">Transactions</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm p-3 tx-stat-card">
                <div class="text-muted small fw-bold mb-1 uppercase" style="font-size:0.7rem; letter-spacing:.1em;">ACTIONABLE</div>
                <div class="fw-bolder h4 mb-0 text-success" id="stat-paid">@actionableCount</div>
                <div class="text-muted x-small mt-1">Can Void / Refund</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm p-3 tx-stat-card">
                <div class="text-muted small fw-bold mb-1 uppercase" style="font-size:0.7rem; letter-spacing:.1em;">VOIDED</div>
                <div class="fw-bolder h4 mb-0 text-danger" id="stat-voided">@voidedCount</div>
                <div class="text-muted x-small mt-1">Cancelled orders</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm p-3 tx-stat-card">
                <div class="text-muted small fw-bold mb-1 uppercase" style="font-size:0.7rem; letter-spacing:.1em;">REFUNDED</div>
                <div class="fw-bolder h4 mb-0 text-info" id="stat-refunded">@refundedCount</div>
                <div class="text-muted x-small mt-1">Returned orders</div>
            </div>
        </div>
    </div>

    <!-- Search & Filter Bar -->
    <div class="card border-0 shadow-sm rounded-3 mb-3 p-3">
        <div class="row g-2 align-items-center">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text bg-light border-0 text-muted ps-3">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="txSearch" class="form-control bg-light border-0 py-2 search-input" placeholder="Search by ID, cashier, or amount...">
                </div>
            </div>
            <div class="col-md-3">
                <select id="statusFilter" class="form-select bg-light border-0 py-2">
                    <option value="">All Statuses</option>
                    <option value="paid">Paid (Actionable)</option>
                    <option value="voided">Voided</option>
                    <option value="refunded">Refunded</option>
                    <option value="other">Other / Locked</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="dateFilter" class="form-select bg-light border-0 py-2">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
            <div class="col-md-1 text-end">
                <button class="btn btn-light border rounded-pill px-3 py-2" id="clearFilters" title="Clear Filters">
                    <i class="fas fa-times text-muted"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card border-0 shadow-sm rounded-3 overflow-hidden mb-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="txTable">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 fw-bold text-muted small uppercase" style="letter-spacing:.05em;">Transaction ID</th>
                        <th class="py-3 fw-bold text-muted small uppercase" style="letter-spacing:.05em;">Date &amp; Time</th>
                        <th class="py-3 fw-bold text-muted small uppercase" style="letter-spacing:.05em;">Cashier</th>
                        <th class="py-3 fw-bold text-muted small uppercase" style="letter-spacing:.05em;">Amount</th>
                        <th class="py-3 fw-bold text-muted small uppercase" style="letter-spacing:.05em;">Status</th>
                        <th class="text-end pe-4 py-3 sticky-action fw-bold text-muted small uppercase" style="letter-spacing:.05em;">Manager Actions</th>
                    </tr>
                </thead>
                <tbody id="txTableBody">
                    @foreach (var order in Model)
                    {
                        var statusClass = "other";
                        if (order.PaymentStatus == "Paid" || order.PaymentStatus == "Paid (Digital)") { statusClass = "paid"; }
                        else if (order.PaymentStatus == "Voided") { statusClass = "voided"; }
                        else if (order.PaymentStatus == "Refunded") { statusClass = "refunded"; }

                        <tr class="tx-row" 
                            data-status="@statusClass.ToLower()"
                            data-date="@order.OrderDate.ToString("yyyy-MM-dd")"
                            data-search="@order.OrderID.ToString().ToLower() @(order.Cashier?.FullName?.ToLower()) @order.FinalAmount.ToString()">
                            <td class="ps-4 py-3">
                                <span class="fw-bold text-primary font-monospace">#@order.OrderID.ToString().Substring(0, 8)</span>
                            </td>
                            <td class="py-3">
                                <div class="small text-muted">@order.OrderDate.ToString("MMM dd, yyyy")</div>
                                <div class="fw-semibold">@order.OrderDate.ToString("HH:mm")</div>
                            </td>
                            <td class="py-3">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px;font-size:0.65rem;font-weight:700;">
                                        @(order.Cashier?.FullName?.Length > 0 ? order.Cashier.FullName.Substring(0,1).ToUpper() : "?")
                                    </div>
                                    <span class="small fw-semibold">@order.Cashier?.FullName</span>
                                </div>
                            </td>
                            <td class="py-3 fw-bolder text-dark">â‚±@order.FinalAmount.ToString("N2")</td>
                            <td class="py-3">
                                @if (order.PaymentStatus == "Paid" || order.PaymentStatus == "Paid (Digital)")
                                {
                                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">
                                        <i class="fas fa-check-circle me-1"></i>PAID
                                    </span>
                                }
                                else if (order.PaymentStatus == "Voided")
                                {
                                    <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3">
                                        <i class="fas fa-ban me-1"></i>VOIDED
                                    </span>
                                }
                                else if (order.PaymentStatus == "Refunded")
                                {
                                    <span class="badge bg-info bg-opacity-10 text-info rounded-pill px-3">
                                        <i class="fas fa-undo me-1"></i>REFUNDED
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3">
                                        <i class="fas fa-clock me-1"></i>@order.PaymentStatus.ToUpper()
                                    </span>
                                }
                            </td>
                            <td class="text-end pe-4 py-3 sticky-action">
                                <div class="d-flex justify-content-end gap-2">
                                    @if (order.PaymentStatus == "Paid" || order.PaymentStatus == "Paid (Digital)")
                                    {
                                        <button class="btn btn-sm btn-outline-danger px-3 rounded-pill void-btn"
                                                data-id="@order.OrderID"
                                                data-bs-toggle="modal"
                                                data-bs-target="#voidModal">
                                            <i class="fas fa-ban me-1"></i>Void
                                        </button>
                                        <button class="btn btn-sm btn-outline-info px-3 rounded-pill refund-btn"
                                                data-id="@order.OrderID"
                                                data-bs-toggle="modal"
                                                data-bs-target="#refundModal">
                                            <i class="fas fa-undo me-1"></i>Refund
                                        </button>
                                    }
                                    else if (order.PaymentStatus == "Pending" || order.PaymentStatus == "Processing")
                                    {
                                        <button class="btn btn-sm btn-outline-primary px-3 rounded-pill sync-btn"
                                                data-id="@order.OrderID"
                                                data-bs-toggle="modal"
                                                data-bs-target="#syncModal">
                                            <i class="fas fa-sync-alt me-1"></i>Sync
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted small fst-italic"><i class="fas fa-lock me-1 opacity-25"></i>Locked</span>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Table Footer / No Results -->
        <div id="noResults" class="text-center py-5 d-none">
            <i class="fas fa-search fa-2x text-muted opacity-25 mb-3 d-block"></i>
            <p class="text-muted fw-bold">No transactions match your search</p>
            <button class="btn btn-light rounded-pill px-4 small" id="clearFilters2">Clear Filters</button>
        </div>
        <div class="page-bar px-4 py-3 d-flex justify-content-between align-items-center">
            <span class="text-muted x-small" id="resultCount"></span>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- Void Confirmation Modal -->
<div class="modal fade" id="voidModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 px-4 pt-4 pb-2">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-danger" style="width:48px;height:48px;">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bolder text-dark mb-0">Void Transaction</h5>
                        <p class="text-muted small mb-0">Critical Manager Override</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 py-3 text-center">
                <div class="p-3 bg-danger bg-opacity-10 rounded-3 mb-3">
                    <p class="text-danger fw-bold mb-0 small"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone.</p>
                </div>
                <p class="text-muted mb-0">The transaction will be marked as <strong class="text-danger">Voided</strong> and removed from revenue calculations.</p>
            </div>
            <div class="modal-footer border-0 px-4 pb-4 pt-2">
                <form asp-action="VoidOrder" method="post" class="w-100 d-flex gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="void-orderid" />
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold flex-fill py-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4 fw-bold flex-fill py-2"><i class="fas fa-ban me-2"></i>Confirm Void</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Refund Confirmation Modal -->
<div class="modal fade" id="refundModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 px-4 pt-4 pb-2">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-info" style="width:48px;height:48px;">
                        <i class="fas fa-undo"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bolder text-dark mb-0">Process Refund</h5>
                        <p class="text-muted small mb-0">Mark order as returned</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 py-3 text-center">
                <div class="p-3 bg-info bg-opacity-10 rounded-3 mb-3">
                    <p class="text-info fw-bold mb-0 small"><i class="fas fa-info-circle me-2"></i>This will update financial records.</p>
                </div>
                <p class="text-muted mb-0">The order will be marked as <strong class="text-info">Refunded</strong> in the financial records.</p>
            </div>
            <div class="modal-footer border-0 px-4 pb-4 pt-2">
                <form asp-action="RefundOrder" method="post" class="w-100 d-flex gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="refund-orderid" />
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold flex-fill py-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info rounded-pill px-4 fw-bold flex-fill py-2 text-white"><i class="fas fa-undo me-2"></i>Confirm Refund</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Sync Confirmation Modal -->
<div class="modal fade" id="syncModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0 px-4 pt-4 pb-2">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-primary" style="width:48px;height:48px;">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bolder text-dark mb-0">Manual Payment Sync</h5>
                        <p class="text-muted small mb-0">Verify with Payment Gateway</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 py-3 text-center">
                <div class="p-3 bg-primary bg-opacity-10 rounded-3 mb-3">
                    <p class="text-primary fw-bold mb-0 small"><i class="fas fa-satellite-dish me-2"></i>Will contact PayMongo / E-Wallet.</p>
                </div>
                <p class="text-muted mb-0">This will verify if the payment was actually completed on the payment gateway and update the status accordingly.</p>
            </div>
            <div class="modal-footer border-0 px-4 pb-4 pt-2">
                <form asp-action="SyncPaymentStatus" method="post" class="w-100 d-flex gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="sync-orderid" />
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold flex-fill py-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold flex-fill py-2"><i class="fas fa-sync-alt me-2"></i>Sync Now</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let currentPage = 1;
            const rowsPerPage = 10;
            let filteredRows = [];

            // Modal triggers
            $('.void-btn').click(function() { $('#void-orderid').val($(this).data('id')); });
            $('.refund-btn').click(function() { $('#refund-orderid').val($(this).data('id')); });
            $('.sync-btn').click(function() { $('#sync-orderid').val($(this).data('id')); });

            const allRows = Array.from(document.querySelectorAll('#txTableBody tr.tx-row'));

            function applyFilters() {
                const search = $('#txSearch').val().toLowerCase().trim();
                const status = $('#statusFilter').val();
                const dateRange = $('#dateFilter').val();

                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

                filteredRows = allRows.filter(rowElement => {
                    const row = $(rowElement);
                    const rowSearch = row.data('search') || '';
                    const rowStatus = row.data('status') || '';
                    const rowDate = row.data('date') || '';

                    const matchesSearch = !search || rowSearch.includes(search);
                    const matchesStatus = !status || rowStatus === status;

                    let matchesDate = true;
                    if (dateRange === 'today') {
                        matchesDate = rowDate === todayStr;
                    } else if (dateRange === 'week') {
                        matchesDate = new Date(rowDate) >= weekStart;
                    } else if (dateRange === 'month') {
                        matchesDate = new Date(rowDate) >= monthStart;
                    }

                    return matchesSearch && matchesStatus && matchesDate;
                });

                currentPage = 1;
                updatePagination();
            }

            function updatePagination() {
                const total = filteredRows.length;
                const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));

                if (currentPage > totalPages) currentPage = totalPages;

                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;

                allRows.forEach(row => row.style.display = 'none');
                filteredRows.slice(start, end).forEach(row => row.style.display = '');

                if (total === 0) {
                    $('#noResults').removeClass('d-none');
                } else {
                    $('#noResults').addClass('d-none');
                }

                document.getElementById('resultCount').textContent = `Showing ${total ? start + 1 : 0} to ${Math.min(end, total)} of ${total} transactions`;
                renderPaginationButtons(totalPages);
            }

            function renderPaginationButtons(totalPages) {
                const container = document.getElementById('pagination');
                if (!container) return;
                container.innerHTML = '';
                if (totalPages <= 1) return;

                const createLi = (page, content, disabled = false, active = false) => {
                    const li = document.createElement('li');
                    li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.innerHTML = content;
                    a.onclick = (e) => {
                        e.preventDefault();
                        if (!disabled && !active) {
                            currentPage = page;
                            updatePagination();
                        }
                    };
                    li.appendChild(a);
                    return li;
                };

                container.appendChild(createLi(currentPage - 1, '<i class="fas fa-chevron-left x-small"></i>', currentPage === 1));

                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        container.appendChild(createLi(i, i, false, i === currentPage));
                    } else if (i === currentPage - 2 || i === currentPage + 2) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = '<span class="page-link">...</span>';
                        container.appendChild(li);
                    }
                }

                container.appendChild(createLi(currentPage + 1, '<i class="fas fa-chevron-right x-small"></i>', currentPage === totalPages));
            }

            $('#txSearch').on('keyup input', applyFilters);
            $('#statusFilter').on('change', applyFilters);
            $('#dateFilter').on('change', applyFilters);

            function clearAll() {
                $('#txSearch').val('');
                $('#statusFilter').val('');
                $('#dateFilter').val('');
                applyFilters();
            }

            $('#clearFilters, #clearFilters2').click(clearAll);

            // Initial load
            applyFilters();
        });
    </script>
}
