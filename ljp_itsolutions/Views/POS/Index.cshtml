@model IEnumerable<ljp_itsolutions.Models.Product>
@{
    ViewData["Title"] = "POS - Create Order";
    var products = Model ?? Enumerable.Empty<ljp_itsolutions.Models.Product>();
    var categories = products.Select(p => p.Category?.CategoryName).Where(c => c != null).Distinct().OrderBy(c => c).ToList();
}

@section Styles {
    <link rel="stylesheet" href="~/css/pos-cashier.css" asp-append-version="true" />
}


<div class="pos-container">
    <div class="products-section">
        <div class="pos-header-actions mb-3">
            <div class="input-group search-bar">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="productSearch" class="form-control border-start-0" placeholder="Search products..." onkeyup="searchProducts()">
            </div>
        </div>

        <div class="category-filter">
            <button class="category-btn active" onclick="filterCategory('All')">All Items</button>
            @foreach (var cat in categories)
            {
                <button class="category-btn" onclick="filterCategory('@cat')">@cat</button>
            }
        </div>

        <div class="products-grid" id="productsGrid">
            @foreach (var product in products)
            {
                var isStocked = product.StockQuantity > 0; // kung naay recipe , dapat i-check pud ang stock sa mga ingredients, pero for simplicity, we just check the product stock here.
                <div class="product-card @(isStocked ? "" : "out-of-stock")" 
                     data-category="@product.Category?.CategoryName" 
                     onclick="@(isStocked ? $"addToCart('{product.ProductID}', '{product.ProductName}', {product.Price})" : "")">
                    <div class="product-image-container">
                        @if (!string.IsNullOrEmpty(product.ImageURL))
                        {
                            <img src="@product.ImageURL" alt="@product.ProductName" class="product-img" />
                        }
                        else
                        {
                            <div class="product-icon">
                                @if (product.Category?.CategoryName == "Coffee") { <i class="fas fa-coffee"></i> }
                                else if (product.Category?.CategoryName == "Tea") { <i class="fas fa-leaf"></i> }
                                else { <i class="fas fa-cookie"></i> }
                            </div>
                        }
                        
                        @if (!isStocked)
                        {
                            <div class="out-of-stock-overlay">
                                <span class="badge bg-danger">Sold Out</span>
                            </div>
                        }
                    </div>
                    <div class="product-info">
                        <p class="product-name">@product.ProductName</p>
                        <p class="product-price">₱@product.Price.ToString("F2")</p>
                    </div>
                </div>
            }
        </div>
    </div>
    
    <div class="cart-section">
        <div class="cart-header">
            <h4>Current Order</h4>
            <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">Clear</button>
        </div>

        <div class="customer-loyalty-section px-3 py-2 bg-light border-bottom">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small fw-bold text-muted">Customer Loyalty</span>
                <button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="showRegisterModal()">
                    <i class="fas fa-user-plus me-1"></i>New
                </button>
            </div>
            <div class="position-relative">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted small"></i></span>
                    <input type="text" id="customerSearch" class="form-control border-start-0" placeholder="Search phone or name..." oninput="searchCustomers()">
                    <button class="btn btn-outline-secondary" id="clearCustomerBtn" style="display:none" onclick="clearSelectedCustomer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="customerSearchResults" class="dropdown-menu w-100 shadow-sm border-0 mt-1" style="display:none; max-height: 200px; overflow-y: auto;">

                </div>
            </div>
            <div id="selectedCustomerDisplay" class="mt-2" style="display:none">
                <div class="d-flex align-items-center gap-2 p-2 bg-white rounded border border-primary border-opacity-25 shadow-sm position-relative">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="fas fa-user small"></i>
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-bold text-dark text-truncate small" id="scName"></div>
                        <div class="text-muted x-small d-flex align-items-center gap-1">
                            <i class="fas fa-coins text-warning"></i>
                            <span id="scPoints">0 pts</span>
                        </div>
                    </div>
                    <button id="redeemBtn" class="btn btn-warning btn-xs px-2 rounded-pill fw-bold text-dark" onclick="toggleRedeem()" style="font-size: 0.65rem;">
                        Redeem
                    </button>
                </div>
            </div>
            <input type="hidden" id="selectedCustomerId" value="">
            <input type="hidden" id="isRedeeming" value="false">
        </div>

        <div class="cart-items" id="cartItems" style="display:none">
        </div>
        <div class="text-center text-muted py-5" id="emptyCartMsg">
            <i class="fas fa-shopping-basket fa-3x mb-3 opacity-20"></i>
            <p>No items in cart</p>
        </div>

        <div class="cart-footer">
            <div class="promotion-area mb-3">
                <div class="input-group input-group-sm">
                    <input type="text" id="promoCode" class="form-control" placeholder="Promo code">
                    <button class="btn btn-outline-secondary" onclick="applyPromo()">Apply</button>
                </div>
                <small id="promoStatus" class="text-success" style="display:none"></small>
            </div>

            <div class="summary-row">
                <span>Subtotal</span>
                <span id="subtotal">₱0.00</span>
            </div>
            <div class="summary-row">
                <span>Tax (5%)</span>
                <span id="tax">₱0.00</span>
            </div>
            <div class="summary-row total">
                <span>Total</span>
                <span id="total">₱0.00</span>
            </div>

            <div class="payment-methods">
                <button class="payment-btn active" onclick="setPayment('Cash')">
                    <i class="fas fa-money-bill-wave mb-1"></i>
                    <span>Cash</span>
                </button>
                <button class="payment-btn" onclick="setPayment('Paymongo')">
                    <i class="fas fa-qrcode mb-1"></i>
                    <span>E-Wallet</span>
                </button>
            </div>

            <div id="cashDetails" class="payment-details-box mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Cash Received:</span>
                    <div class="input-group input-group-sm w-50">
                        <span class="input-group-text bg-light border-end-0">₱</span>
                        <input type="number" id="cashReceived" class="form-control border-start-0 text-end fw-bold" placeholder="0.00" oninput="calculateChange()">
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Change:</span>
                    <span id="changeAmount" class="fw-bold text-success fs-5">₱0.00</span>
                </div>
            </div>

            <button class="pay-now-btn transition-hover" onclick="processPayment()">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-coins"></i>
                    <span>Finalize Transaction</span>
                </div>
            </button>
        </div>
    </div>
    </div>
</div>


<div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-success">
                    <i class="fas fa-check-circle me-2"></i>Transaction Successful
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="receiptModalContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading Receipt...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 flex-column gap-2">
                <div class="input-group w-100 mb-2">
                    <input type="email" id="receiptEmail" class="form-control" placeholder="customer@email.com">
                    <button class="btn btn-outline-primary" type="button" onclick="sendEReceipt()" id="sendReceiptBtn">
                        <i class="fas fa-paper-plane me-1"></i>Email
                    </button>
                </div>
                <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
                <button type="button" class="btn btn-light w-100 py-2 border" data-bs-dismiss="modal">
                    New Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Customer Modal -->
<div class="modal fade" id="registerCustomerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Quick Enrollment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="registerCustomerForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Full Name</label>
                        <input type="text" id="regName" class="form-control py-2 shadow-sm" placeholder="e.g. Juan Dela Cruz" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Phone Number</label>
                        <input type="tel" id="regPhone" class="form-control py-2 shadow-sm" placeholder="09xxxxxxxxx">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Email (Optional)</label>
                        <input type="email" id="regEmail" class="form-control py-2 shadow-sm" placeholder="user@gmail.com">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0 pb-4 justify-content-center">
                <button type="button" class="btn btn-primary px-5 py-2 fw-bold w-100 mx-3 rounded-pill" onclick="registerCustomer()">
                    Join Loyalty Program
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Paymongo Simulation Modal -->
<div class="modal fade" id="paymongoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header bg-primary text-white border-0" style="border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                <h5 class="modal-title fw-bold">E-Wallet Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-5">
                <div class="mb-4 d-flex justify-content-center align-items-center" style="min-height: 250px;">
                    <div id="qrContainer" class="p-3 bg-white border rounded shadow-sm d-flex align-items-center justify-content-center" style="width: 250px; height: 250px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <h4 class="fw-bold mb-2">Scan to Pay</h4>
                <p id="qrInstruction" class="text-muted mb-4 small">Generating your unique QR Ph code...</p>
                <div class="d-flex justify-content-center gap-4">
                    <div class="p-2 border rounded bg-light d-flex align-items-center justify-content-center" style="width: 100px; height: 50px;">
                        <img src="./images/gcash.png" style="max-height: 25px; max-width: 80px;" alt="GCash" />
                    </div>
                    <div class="p-2 border rounded bg-light d-flex align-items-center justify-content-center" style="width: 100px; height: 50px;">
                        <img src="./images/maya.png" style="max-height: 25px; max-width: 80px;" alt="Maya" />
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" id="paymongoDoneBtn" class="btn btn-primary w-100 py-2 fw-bold" onclick="window.location.href='@Url.Action("TransactionHistory", "Cashier")'" disabled>Waiting for Payment...</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let cart = [];
        let paymentMethod = 'Cash';

        function addToCart(id, name, price) {
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ id, name, price, qty: 1 });
            }
            renderCart();
        }

        function updateQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) {
                    cart = cart.filter(i => i.id !== id);
                }
            }
            renderCart();
        }

        function clearCart() {
            cart = [];
            renderCart();
        }

        let totalAmount = 0;

        function renderCart() {
            const cartContainer = document.getElementById('cartItems');
            const emptyMsg = document.getElementById('emptyCartMsg');
            
            if (cart.length === 0) {
                cartContainer.style.display = 'none';
                if (emptyMsg) emptyMsg.style.display = 'block';
                updateTotals(0);
                return;
            }

            if (emptyMsg) emptyMsg.style.display = 'none';
            cartContainer.style.display = 'block';
            cartContainer.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h6>${item.name}</h6>
                        <span>₱${item.price.toFixed(2)} / unit</span>
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateQty('${item.id}', -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="updateQty('${item.id}', 1)">+</button>
                    </div>
                    <div class="fw-bold">₱${(item.price * item.qty).toFixed(2)}</div>
                </div>
            `).join('');

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            updateTotals(subtotal);
        }

        let isRedeeming = false;
        let customerPoints = 0;

        function toggleRedeem() {
            if (customerPoints < 5) {
                alert('You need at least 5 points to redeem a ₱50 discount.');
                return;
            }
            isRedeeming = !isRedeeming;
            const btn = document.getElementById('redeemBtn');
            const sub = document.getElementById('subtotal').innerText.replace('₱', '');
            
            if (isRedeeming) {
                btn.innerText = 'Redeeming';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-warning');
            } else {
                btn.innerText = 'Redeem';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
            renderCart();
        }

        function updateTotals(subtotal) {
            let discountFromPoints = isRedeeming ? 50 : 0;
            if (discountFromPoints > subtotal) discountFromPoints = subtotal;

            const tax = (subtotal - discountFromPoints) * 0.05;
            totalAmount = (subtotal - discountFromPoints) + tax;

            document.getElementById('subtotal').innerText = `₱${subtotal.toFixed(2)}`;
            
            const promoArea = document.querySelector('.promotion-area');
            let pointsLabel = document.getElementById('pointsDiscountRow');
            if (isRedeeming) {
                if (!pointsLabel) {
                    const row = document.createElement('div');
                    row.id = 'pointsDiscountRow';
                    row.className = 'summary-row text-success fw-bold';
                    row.innerHTML = `<span>Point Reward</span><span>-₱${discountFromPoints.toFixed(2)}</span>`;
                    document.querySelector('.summary-row.total').before(row);
                } else {
                    pointsLabel.querySelector('span:last-child').innerText = `-₱${discountFromPoints.toFixed(2)}`;
                }
            } else if (pointsLabel) {
                pointsLabel.remove();
            }

            document.getElementById('tax').innerText = `₱${tax.toFixed(2)}`;
            document.getElementById('total').innerText = `₱${totalAmount.toFixed(2)}`;
            
            if (paymentMethod === 'Cash') {
                calculateChange();
            }
        }

        function calculateChange() {
            const cash = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = cash - totalAmount;
            const changeDisplay = document.getElementById('changeAmount');
            
            changeDisplay.innerText = `₱${Math.max(0, change).toFixed(2)}`;
            if (change < 0 && cash > 0) {
                changeDisplay.classList.add('text-danger');
                changeDisplay.classList.remove('text-success');
            } else {
                changeDisplay.classList.remove('text-danger');
                changeDisplay.classList.add('text-success');
            }
        }

        function searchProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase();
            document.querySelectorAll('.product-card').forEach(card => {
                const name = card.querySelector('.product-name').innerText.toLowerCase();
                if (name.includes(query)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function applyPromo() {
            const code = document.getElementById('promoCode').value;
            const status = document.getElementById('promoStatus');
            if (code.toUpperCase() === 'FIRSTBUY') {
                status.innerText = 'Promo applied: 10% Off';
                status.style.display = 'block';
                status.classList.replace('text-danger', 'text-success');
            } else {
                status.innerText = 'Invalid code';
                status.style.display = 'block';
                status.classList.replace('text-success', 'text-danger');
            }
        }

        function filterCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === category || (category === 'All' && btn.innerText === 'All Items'));
            });

            // Filter products
            document.querySelectorAll('.product-card').forEach(card => {
                if (category === 'All' || card.dataset.category === category) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
            document.getElementById('productSearch').value = '';
        }

        function setPayment(method) {
            paymentMethod = method;
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(method));
            });

            const cashDetails = document.getElementById('cashDetails');
            if (method === 'Cash') {
                cashDetails.style.display = 'block';
            } else {
                cashDetails.style.display = 'none';
            }
        }

        function processPayment() {
            if (cart.length === 0) {
                alert('Please add items to cart first.');
                return;
            }

            if (paymentMethod === 'Cash') {
                const cash = parseFloat(document.getElementById('cashReceived').value) || 0;
                if (cash < totalAmount) {
                    alert('Insufficient cash provided.');
                    return;
                }
            }

            if (paymentMethod === 'Paymongo') {
                generateRealQR();
                return;
            }
            
            submitOrder();
        }

        async function generateRealQR() {
            const modalEl = document.getElementById('paymongoModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            const qrContainer = document.getElementById('qrContainer');
            const qrInstruction = document.getElementById('qrInstruction');
            const doneBtn = document.getElementById('paymongoDoneBtn');

            const productIds = cart.flatMap(item => Array(item.qty).fill(item.id));
            const promoCode = document.getElementById('promoCode').value;

            try {
                const response = await fetch('@Url.Action("CreatePayMongoOrder", "Cashier")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ productIds, promoCode })
                });

                if (response.ok) {
                    const data = await response.json();
                    qrContainer.innerHTML = `<img src="${data.qrCodeUrl}" alt="Real QR Ph" class="img-fluid" />`;
                    qrInstruction.innerText = "Scan this QR Ph code with GCash or Maya to pay.";
                    doneBtn.innerText = "I Have Paid / Complete Order";
                    doneBtn.disabled = false;
                } else {
                    const error = await response.text();
                    qrContainer.innerHTML = `<div class="text-danger p-3"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br><small>${error}</small></div>`;
                    qrInstruction.innerText = "Error generating QR code.";
                }
            } catch (err) {
                qrContainer.innerHTML = `<div class="text-danger p-3"><i class="fas fa-wifi fa-2x mb-2"></i><br><small>Connection Error</small></div>`;
                qrInstruction.innerText = "Please check your internet connection.";
            }
        }

        async function finalizePaymongo() {
            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating QR Ph...';
            btn.disabled = true;

            const productIds = cart.flatMap(item => Array(item.qty).fill(item.id));
            const promoCode = document.getElementById('promoCode').value;

            try {
                const response = await fetch('@Url.Action("CreatePayMongoOrder", "Cashier")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ productIds, promoCode })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update QR Code Image in Modal
                    const qrImg = document.querySelector('#paymongoModal img[alt="Payment QR Code"]');
                    if (qrImg) {
                        qrImg.src = data.qrCodeUrl;
                    }

                    // Change button behavior to "Done"
                    btn.innerHTML = 'Complete Order';
                    btn.disabled = false;
                    btn.onclick = () => window.location.href = '@Url.Action("TransactionHistory", "Cashier")';
                    
                } else {
                    const error = await response.text();
                    alert('Error: ' + error);
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert('Connection error. Please check your internet.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function submitOrder() {
            const productIds = cart.flatMap(item => Array(item.qty).fill(item.id));
            const promoCode = document.getElementById('promoCode').value;
            const customerId = document.getElementById('selectedCustomerId').value || null;
            
            // Show Receipt Modal in Loading State
            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            receiptModal.show();

            try {
                const response = await fetch('@Url.Action("PlaceOrder", "Cashier")', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ 
                        productIds, 
                        paymentMethod, 
                        promoCode,
                        customerId: customerId ? parseInt(customerId) : null,
                        redeemPoints: isRedeeming
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentOrderId = data.orderId; 
                        loadReceipt(data.orderId);
                        
                        if (selectedCustomerEmail) {
                            const btn = document.getElementById('sendReceiptBtn');
                            btn.innerHTML = '<i class="fas fa-check"></i> Auto-Sent';
                            btn.classList.replace('btn-outline-primary', 'btn-success');
                            btn.disabled = true;
                            document.getElementById('receiptEmail').value = selectedCustomerEmail;
                        }
                    } else {
                        alert('Order failed: ' + (data.message || 'Unknown error'));
                        receiptModal.hide();
                    }
                } else {
                    const error = await response.text();
                    alert('Error placing order: ' + error);
                    receiptModal.hide();
                }
            } catch (err) {
                console.error(err);
                alert('Connection error while placing order.');
                receiptModal.hide();
            }
        }

        async function loadReceipt(orderId) {
            const content = document.getElementById('receiptModalContent');
            try {
                const response = await fetch(`/Cashier/GetReceiptPartial/${orderId}`);
                if (response.ok) {
                    content.innerHTML = await response.text();
                    // Auto-print after a short delay for rendering
                    setTimeout(() => {
                        printReceipt();
                    }, 500);
                } else {
                    content.innerHTML = '<div class="text-danger text-center">Failed to load receipt details.</div>';
                }
            } catch (err) {
                content.innerHTML = '<div class="text-danger text-center">Error loading receipt.</div>';
            }
        }

        let currentOrderId = null;
        let selectedCustomerEmail = null;

        async function sendEReceipt() {
            if (!currentOrderId) {
                alert('No active order context. Please try again.');
                return;
            }

            const emailInput = document.getElementById('receiptEmail');
            const btn = document.getElementById('sendReceiptBtn');
            const email = emailInput.value.trim();

            if (!email || !email.includes('@@')) {
                alert('Please enter a valid email address.');
                return;
            }

            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;

            try {
                const response = await fetch('@Url.Action("SendReceipt", "Cashier")?orderId=' + currentOrderId + '&email=' + encodeURIComponent(email), {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });

                const data = await response.json();
                if (data.success) {
                    btn.innerHTML = '<i class="fas fa-check text-success"></i> Sent!';
                    btn.classList.replace('btn-outline-primary', 'btn-outline-success');
                    setTimeout(() => {
                        emailInput.value = '';
                        btn.innerHTML = originalBtnHtml;
                        btn.classList.replace('btn-outline-success', 'btn-outline-primary');
                        btn.disabled = false;
                    }, 3000);
                } else {
                    alert(data.message || 'Failed to send receipt');
                    btn.innerHTML = originalBtnHtml;
                    btn.disabled = false;
                }
            } catch(e) {
                alert('Network error while sending receipt.');
                btn.innerHTML = originalBtnHtml;
                btn.disabled = false;
            }
        }

        function printReceipt() {
            const printContent = document.getElementById('receiptModalContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            window.print();
        }

        // Customer Loyalty Logic
        let searchTimeout;
        async function searchCustomers() {
            const query = document.getElementById('customerSearch').value;
            const resultsDiv = document.getElementById('customerSearchResults');
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const response = await fetch(`@Url.Action("SearchCustomers", "Cashier")?query=${encodeURIComponent(query)}`);
                const customers = await response.json();
                
                if (customers.length > 0) {
                    resultsDiv.innerHTML = customers.map(c => `
                        <a href="javascript:void(0)" class="dropdown-item py-2 border-bottom border-light" onclick='selectCustomer(${JSON.stringify(c)})'>
                            <div class="fw-bold small text-dark">${c.fullName}</div>
                            <div class="x-small text-muted">${c.phoneNumber || 'No phone'} • ${c.points} pts</div>
                        </a>
                    `).join('');
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="px-3 py-2 small text-muted text-center italic">No customers found</div>';
                    resultsDiv.style.display = 'block';
                }
            }, 300);
        }

        function selectCustomer(customer) {
            document.getElementById('selectedCustomerId').value = customer.customerID;
            document.getElementById('scName').innerText = customer.fullName;
            document.getElementById('scPoints').innerText = `${customer.points} pts`;
            customerPoints = customer.points;
            selectedCustomerEmail = customer.email;
            
            document.getElementById('customerSearch').style.display = 'none';
            document.getElementById('selectedCustomerDisplay').style.display = 'block';
            document.getElementById('clearCustomerBtn').style.display = 'block';
            document.getElementById('customerSearchResults').style.display = 'none';
            document.getElementById('customerSearch').value = '';
            
            document.getElementById('redeemBtn').style.display = customerPoints >= 5 ? 'block' : 'none';
        }

        function clearSelectedCustomer() {
            document.getElementById('selectedCustomerId').value = '';
            document.getElementById('customerSearch').style.display = 'block';
            document.getElementById('selectedCustomerDisplay').style.display = 'none';
            document.getElementById('clearCustomerBtn').style.display = 'none';
            isRedeeming = false;
            customerPoints = 0;
            selectedCustomerEmail = null;
            renderCart();
        }

        function showRegisterModal() {
            const modal = new bootstrap.Modal(document.getElementById('registerCustomerModal'));
            modal.show();
        }

        async function registerCustomer() {
            const fullName = document.getElementById('regName').value;
            const phoneNumber = document.getElementById('regPhone').value;
            const email = document.getElementById('regEmail').value;

            if (!fullName) {
                alert('Please enter a name.');
                return;
            }

            const response = await fetch('@Url.Action("RegisterCustomer", "Cashier")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ fullName, phoneNumber, email })
            });

            const data = await response.json();
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('registerCustomerModal')).hide();
                selectCustomer({ 
                    customerID: data.customerId, 
                    fullName: data.fullName, 
                    phoneNumber: phoneNumber, 
                    points: 0,
                    email: email
                });
                document.getElementById('registerCustomerForm').reset();
            } else {
                alert(data.message || 'Registration failed');
            }
        }

        // Handle modal close to reset POS
        document.getElementById('receiptModal').addEventListener('hidden.bs.modal', function () {
            location.reload();
        });
    </script>
}
