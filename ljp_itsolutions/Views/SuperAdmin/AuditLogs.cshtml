@model IEnumerable<ljp_itsolutions.Models.AuditLog>
@{
    Layout = "_Layout";
    ViewData["Title"] = "System Audit Trail";
    var users = ViewBag.Users as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
}

<div class="container-fluid py-2">
    <!-- Filters Bar -->
    <div class="row g-3 mb-4 align-items-center">
        <div class="col-md-3">
            <div class="input-group shadow-sm rounded-pill overflow-hidden border">
                <span class="input-group-text bg-white border-0 ps-3">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="logSearch" class="form-control border-0 shadow-none ps-2 py-2" placeholder="Search activities...">
            </div>
        </div>
        <div class="col-md-3">
            <select id="userFilter" class="form-select shadow-sm rounded-pill border py-2">
                <option value="">All Operators</option>
                <option value="System">System Process</option>
                @foreach (var user in users)
                {
                    <option value="@user.FullName">@user.FullName</option>
                }
            </select>
        </div>
        <div class="col-md-4">
            <div class="d-flex align-items-center gap-2">
                <input type="date" id="dateFrom" class="form-control shadow-sm rounded-pill border py-2" title="From Date">
                <span class="text-muted">to</span>
                <input type="date" id="dateTo" class="form-control shadow-sm rounded-pill border py-2" title="To Date">
            </div>
        </div>
        <div class="col-md-2 text-end">
            <button id="resetFilters" class="btn btn-light border rounded-pill px-4 ms-auto">
                Reset
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0" id="auditTable">
                    <thead class="bg-light bg-opacity-50">
                        <tr>
                            <th class="ps-4 py-3 text-uppercase x-small fw-bold text-muted" style="width: 200px;">Timestamp</th>
                            <th class="py-3 text-uppercase x-small fw-bold text-muted">Operator Info</th>
                            <th class="py-3 text-uppercase x-small fw-bold text-muted">Action Performed</th>
                            <th class="pe-4 py-3 text-end text-uppercase x-small fw-bold text-muted" style="width: 150px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model)
                        {
                            <tr class="log-row" data-user="@((log.User?.FullName) ?? "System")" data-timestamp="@log.Timestamp.ToString("yyyy-MM-dd")">
                                <td class="ps-4">
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold text-dark small">@log.Timestamp.ToString("MMM dd, yyyy")</span>
                                        <span class="text-muted x-small">@log.Timestamp.ToString("HH:mm:ss")</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="avatar-xs rounded-circle bg-light d-flex align-items-center justify-content-center border" style="width: 28px; height: 28px; font-size: 0.7rem;">
                                            <i class="fas @(log.UserID == null ? "fa-robot" : "fa-user") opacity-50"></i>
                                        </div>
                                        <div>
                                            <p class="mb-0 small fw-bold text-dark">@((log.User?.FullName) ?? "System Process")</p>
                                            <p class="text-muted x-small mb-0">@(log.User?.Role ?? "Internal")</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="small fw-medium text-dark activity-text">@log.Action</span>
                                </td>
                                <td class="pe-4 text-end">
                                    <span class="badge rounded-pill bg-success bg-opacity-10 text-success border border-success border-opacity-10 px-3 x-small">SECURE</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center p-3 bg-light border-top">
            <div class="text-muted x-small">
                Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span id="totalItems">0</span> logs
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination">
                    <!-- Pagination buttons will be injected here -->
                </ul>
            </nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Pagination state
        let currentPage = 1;
        const rowsPerPage = 15;
        let filteredRows = [];

        function initPagination() {
            const rows = Array.from(document.querySelectorAll('#auditTable tbody tr.log-row'));
            filteredRows = rows;
            updatePagination();
        }

        function updatePagination() {
            const totalItems = filteredRows.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            // Hide all rows
            document.querySelectorAll('#auditTable tbody tr.log-row').forEach(row => row.style.display = 'none');
            
            // Show filtered
            filteredRows.slice(start, end).forEach(row => row.style.display = '');

            // Update range text
            if (totalItems > 0) {
                document.getElementById('startRange').textContent = start + 1;
                document.getElementById('endRange').textContent = Math.min(end, totalItems);
                document.getElementById('totalItems').textContent = totalItems;
            } else {
                document.getElementById('startRange').textContent = 0;
                document.getElementById('endRange').textContent = 0;
                document.getElementById('totalItems').textContent = 0;
            }

            renderPaginationButtons(totalPages);
        }

        function renderPaginationButtons(totalPages) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            if (totalPages <= 1) return;

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left x-small"></i></a>`;
            container.appendChild(prevLi);

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                    container.appendChild(li);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    container.appendChild(li);
                }
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right x-small"></i></a>`;
            container.appendChild(nextLi);
        }

        window.changePage = function(page) {
            if (page < 1 || page > Math.ceil(filteredRows.length / rowsPerPage)) return;
            currentPage = page;
            updatePagination();
            event.preventDefault();
        };

        $(document).ready(function() {
            initPagination();

            function filterLogs() {
                var searchTerm = $('#logSearch').val().toLowerCase();
                var userFilter = $('#userFilter').val();
                var dateFrom = $('#dateFrom').val();
                var dateTo = $('#dateTo').val();
                var allRows = Array.from(document.querySelectorAll('.log-row'));

                filteredRows = allRows.filter(function(row) {
                    var $row = $(row);
                    var actionText = $row.find('.activity-text').text().toLowerCase();
                    var userName = $row.data('user');
                    var logDate = $row.data('timestamp');

                    var matchesSearch = actionText.includes(searchTerm);
                    var matchesUser = userFilter === "" || userName === userFilter;
                    
                    var matchesDate = true;
                    if (dateFrom && logDate < dateFrom) matchesDate = false;
                    if (dateTo && logDate > dateTo) matchesDate = false;

                    return matchesSearch && matchesUser && matchesDate;
                });

                currentPage = 1;
                updatePagination();

                if (filteredRows.length === 0) {
                    if ($('#noResultsRow').length === 0) {
                        $('#auditTable tbody').append('<tr id="noResultsRow"><td colspan="4" class="text-center py-5 text-muted"><i class="fas fa-search-minus fa-3x mb-3 opacity-25"></i><p>No audit records found matching the selected filters.</p></td></tr>');
                    }
                } else {
                    $('#noResultsRow').remove();
                }
            }

            $('#logSearch').on('keyup', filterLogs);
            $('#userFilter, #dateFrom, #dateTo').on('change', filterLogs);
            
            $('#resetFilters').click(function() {
                $('#logSearch').val('');
                $('#userFilter').val('');
                $('#dateFrom').val('');
                $('#dateTo').val('');
                filterLogs();
            });
        });
    </script>
}

<style>
    .x-small { font-size: 0.75rem; }
</style>
