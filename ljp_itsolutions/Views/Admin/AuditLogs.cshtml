@model IEnumerable<ljp_itsolutions.Models.AuditLog>
@{
    ViewData["Title"] = "Audit Logs";
    var totalLogs = Model.Count();
    var logins = Model.Count(l => l.Action.ToLower().Contains("login"));
    var alerts = Model.Count(l => l.Action.ToLower().Contains("fail") || l.Action.ToLower().Contains("error") || l.Action.ToLower().Contains("delete") || l.Action.ToLower().Contains("archive"));
}

<div class="container-fluid py-4 animate__animated animate__fadeIn">
    <!-- Header -->
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Audit Logs</h2>
            <p class="text-muted small"><i class="far fa-calendar-alt me-1"></i> @DateTime.Now.ToString("dddd, MMMM dd, yyyy")</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white shadow-sm rounded-pill px-3" onclick="location.reload()">
                <i class="fas fa-sync-alt text-primary me-2"></i>Refresh
            </button>
            <button class="btn btn-primary shadow-sm rounded-pill px-4">
                <i class="fas fa-file-export me-2"></i>Export Logs
            </button>
        </div>
    </div>

    <!-- Summary KPIs -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="kpi-card h-100 border-0 shadow-sm" style="border-left: 5px solid #3b82f6 !important;">
                <div class="d-flex align-items-center w-100 gap-3">
                    <div class="kpi-card-icon bg-blue-light" style="background: #eff6ff; color: #3b82f6;">
                        <i class="fas fa-history fa-lg"></i>
                    </div>
                    <div class="text-start">
                        <p class="kpi-card-label mb-0">Total Activity</p>
                        <h3 class="kpi-card-value">@totalLogs</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card h-100 border-0 shadow-sm" style="border-left: 5px solid #10b981 !important;">
                <div class="d-flex align-items-center w-100 gap-3">
                    <div class="kpi-card-icon bg-green-light" style="background: #ecfdf5; color: #10b981;">
                        <i class="fas fa-user-check fa-lg"></i>
                    </div>
                    <div class="text-start">
                        <p class="kpi-card-label mb-0">Login Events</p>
                        <h3 class="kpi-card-value">@logins</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card h-100 border-0 shadow-sm" style="border-left: 5px solid #ef4444 !important;">
                <div class="d-flex align-items-center w-100 gap-3">
                    <div class="kpi-card-icon bg-red-light" style="background: #fef2f2; color: #ef4444;">
                        <i class="fas fa-shield-virus fa-lg"></i>
                    </div>
                    <div class="text-start">
                        <p class="kpi-card-label mb-0">Security Alerts</p>
                        <h3 class="kpi-card-value">@alerts</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 p-3 bg-white">
        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
            <div class="input-group" style="max-width: 400px;">
                <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="logSearch" class="form-control bg-light border-0 shadow-none py-2" placeholder="Search by user, action, or date...">
            </div>
            <div class="d-flex gap-2">
                <select id="typeFilter" class="form-select border-0 bg-light shadow-none" style="width: 150px;">
                    <option value="">All Types</option>
                    <option value="login">Logins</option>
                    <option value="create">Created</option>
                    <option value="update">Updates</option>
                    <option value="delete">Deletions</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="modern-table shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="logsTable">
                <thead>
                    <tr>
                        <th class="ps-4">Timestamp</th>
                        <th>User Account</th>
                        <th>Activity Description</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var log in Model)
                        {
                            var actionType = log.Action.ToLower();
                            var badgeClass = "secondary";
                            var icon = "info-circle";

                            if (actionType.Contains("login")) { badgeClass = "success"; icon = "sign-in-alt"; }
                            else if (actionType.Contains("logout")) { badgeClass = "secondary"; icon = "sign-out-alt"; }
                            else if (actionType.Contains("create") || actionType.Contains("add") || actionType.Contains("restore")) { badgeClass = "primary"; icon = "plus-circle"; }
                            else if (actionType.Contains("update") || actionType.Contains("edit")) { badgeClass = "info"; icon = "edit"; }
                            else if (actionType.Contains("delete") || actionType.Contains("remove") || actionType.Contains("archive")) { badgeClass = "danger"; icon = "trash"; }
                            else if (actionType.Contains("fail") || actionType.Contains("error") || actionType.Contains("unauthorized")) { badgeClass = "danger"; icon = "exclamation-triangle"; }

                            <tr onclick="openLogModal(@log.AuditID)" class="cursor-pointer log-row">
                                <td class="ps-4">
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold text-dark">@log.Timestamp.ToString("HH:mm:ss")</span>
                                        <span class="text-muted x-small">@log.Timestamp.ToString("MMM dd, yyyy")</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center border" style="width: 38px; height: 38px; overflow: hidden;">
                                            @if (log.User != null && !string.IsNullOrEmpty(log.User.ProfilePictureUrl)) {
                                                <img src="@log.User.ProfilePictureUrl" class="w-100 h-100 object-fit-cover shadow-sm">
                                            } else {
                                                <i class="fas fa-user-shield text-muted small"></i>
                                            }
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">@(log.User?.FullName ?? "System Process")</div>
                                            <div class="text-muted x-small">@@@(log.User?.Username ?? "system")</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="status-icon bg-@badgeClass bg-opacity-10 text-@badgeClass d-flex align-items-center justify-content-center rounded-circle" style="width: 32px; height: 32px;">
                                            <i class="fas fa-@icon small"></i>
                                        </div>
                                        <span class="text-dark fw-semibold">@log.Action</span>
                                    </div>
                                </td>
                            </tr>
                            
                            <!-- Hidden Data Store -->
                            <div class="d-none log-data" id="data-@log.AuditID"
                                 data-time="@log.Timestamp.ToString("MMM dd, yyyy HH:mm:ss")"
                                 data-user="@(log.User?.FullName ?? "System")"
                                 data-username="@(log.User?.Username ?? "N/A")"
                                 data-action="@log.Action"
                                 data-icon="@icon"
                                 data-color="@badgeClass">
                            </div>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3" class="text-center py-5">
                                <div class="py-5">
                                    <i class="fas fa-shield-alt fa-3x text-muted opacity-25 mb-3"></i>
                                    <h5 class="text-muted">No audit logs discovered yet</h5>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center p-3 bg-light border-top">
            <div class="text-muted x-small">
                Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span id="totalItems">0</span> logs
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination">
                    <!-- Pagination buttons will be injected here -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-light border-0">
                <h6 class="modal-title fw-bold text-dark"><i class="fas fa-info-circle me-2"></i>Log Detail View</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div id="modalIconContainer" class="avatar-lg rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-info-circle fa-2x" id="modalIcon"></i>
                    </div>
                    <h5 class="fw-bold text-dark mb-1" id="modalAction">Action</h5>
                    <p class="text-muted small" id="modalTime">Time</p>
                </div>

                <div class="p-3 bg-light rounded-3 border">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-sm bg-white border rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                            <i class="fas fa-user-lock text-muted"></i>
                        </div>
                        <div>
                            <small class="text-muted text-uppercase fw-bold x-small d-block">Performed By</small>
                            <div class="fw-bold text-dark h6 mb-0" id="modalUser">User</div>
                            <div class="text-muted x-small" id="modalUsername">@@username</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-3 pt-0">
                <button type="button" class="btn btn-primary rounded-pill w-100 fw-bold" data-bs-dismiss="modal">Acknowledge</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const logModalEl = document.getElementById('logModal');
        const logModal = new bootstrap.Modal(logModalEl);
        
        // Pagination state
        let currentPage = 1;
        const rowsPerPage = 10;
        let filteredRows = [];

        function initPagination() {
            const rows = Array.from(document.querySelectorAll('#logsTable tbody tr.log-row'));
            filteredRows = rows;
            updatePagination();
        }

        function updatePagination() {
            const totalItems = filteredRows.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            // Hide all rows first
            document.querySelectorAll('#logsTable tbody tr.log-row').forEach(row => row.style.display = 'none');
            
            // Show only relevant rows
            filteredRows.slice(start, end).forEach(row => row.style.display = '');

            // Update range text
            if (totalItems > 0) {
                document.getElementById('startRange').textContent = start + 1;
                document.getElementById('endRange').textContent = Math.min(end, totalItems);
                document.getElementById('totalItems').textContent = totalItems;
            } else {
                document.getElementById('startRange').textContent = 0;
                document.getElementById('endRange').textContent = 0;
                document.getElementById('totalItems').textContent = 0;
            }

            renderPaginationButtons(totalPages);
        }

        function renderPaginationButtons(totalPages) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left x-small"></i></a>`;
            container.appendChild(prevLi);

            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                    container.appendChild(li);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    container.appendChild(li);
                }
            }

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right x-small"></i></a>`;
            container.appendChild(nextLi);
        }

        window.changePage = function(page) {
            if (page < 1 || page > Math.ceil(filteredRows.length / rowsPerPage)) return;
            currentPage = page;
            updatePagination();
            event.preventDefault();
        };

        // Search and Filter Override
        function filterLogs() {
            const searchValue = document.getElementById('logSearch').value.toLowerCase();
            const typeValue = document.getElementById('typeFilter').value.toLowerCase();
            
            const allRows = Array.from(document.querySelectorAll('#logsTable tbody tr.log-row'));
            
            filteredRows = allRows.filter(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesType = typeValue === "" || text.includes(typeValue);
                return matchesSearch && matchesType;
            });
            
            currentPage = 1;
            updatePagination();
            
            // Show no results row if needed
            const noResults = document.querySelector('#logsTable tbody tr:not(.log-row)');
            if (noResults) {
                noResults.style.display = filteredRows.length === 0 ? '' : 'none';
            }
        }

        document.getElementById('logSearch').addEventListener('keyup', filterLogs);
        document.getElementById('typeFilter').addEventListener('change', filterLogs);

        // Initial setup
        document.addEventListener('DOMContentLoaded', initPagination);

        function openLogModal(id) {
            const data = document.getElementById(`data-${id}`);
            if (!data) return;

            document.getElementById('modalAction').textContent = data.dataset.action;
            document.getElementById('modalTime').textContent = data.dataset.time;
            document.getElementById('modalUser').textContent = data.dataset.user;
            document.getElementById('modalUsername').textContent = data.dataset.username !== 'N/A' ? '@@' + data.dataset.username : 'System Core';

            const color = data.dataset.color;
            const icon = data.dataset.icon;
            
            document.getElementById('modalIcon').className = `fas fa-${icon} fa-2x text-${color}`;
            document.getElementById('modalIconContainer').style.background = `rgba(${getColorRGB(color)}, 0.1)`;
            
            logModal.show();
        }

        function getColorRGB(colorName) {
            const colors = {
                'primary': '59, 130, 246',
                'success': '16, 185, 129',
                'danger': '239, 68, 68',
                'warning': '245, 158, 11',
                'info': '14, 165, 233',
                'secondary': '108, 117, 125'
            };
            return colors[colorName] || '108, 117, 125';
        }
    </script>
}

<style>
    .cursor-pointer { cursor: pointer; }
    .x-small { font-size: 0.75rem; }
    .object-fit-cover { object-fit: cover; }
    .bg-blue-light { background: #eff6ff; }
    .bg-green-light { background: #ecfdf5; }
    .bg-red-light { background: #fef2f2; }
    
    .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important; }
    .rounded-4 { border-radius: 1rem !important; }
    
    .kpi-card {
        padding: 1.25rem;
        background: white;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); }
    
    .status-icon {
        flex-shrink: 0;
    }
</style>
